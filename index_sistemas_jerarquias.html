<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0" /> -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Organigrama LIRIS S.A.</title>
    <!-- <script src="Balkan/orgchart.js"></script> -->
    <script src="BalkanPro/orgchart.js"></script>
    <!-- <script src="main.js"></script> -->
    <link rel="stylesheet" href="styles.css" />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />

    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  </head>
  <body>
    <div id="status-message">Cargando...</div>
    <div id="error-message"></div>

    <div id="details-overlay">
      <div id="custom-details-form">
        <img id="details-img" src="" alt="Foto de perfil" />

        <h2 id="details-name" data-field="nombre">[Nombre Completo]</h2>
        <p id="details-puesto" data-field="puesto">[Puesto de Trabajo]</p>

        <div class="details-info-block">
          <div class="details-info-line">
            <span class="details-info-label">Email:</span>
            <span class="details-info-value" data-field="email">[email]</span>
          </div>
          <div class="details-info-line">
            <span class="details-info-label">L√≠nea Negocio:</span>
            <span class="details-info-value" data-field="lineaNegocio"
              >[lineaNegocio]</span
            >
          </div>
          <div class="details-info-line">
            <span class="details-info-label">Centro Costo:</span>
            <span class="details-info-value" data-field="centroCosto"
              >[centroCosto]</span
            >
          </div>
          <div class="details-info-line">
            <span class="details-info-label">Departamento:</span>
            <span class="details-info-value" data-field="departamento"
              >[departamento]</span
            >
          </div>
        </div>

        <div class="details-buttons">
          <button id="btn-manual-funciones" class="details-btn btn-morado">
            Manual de Funciones
          </button>
          <button id="btn-manual-procedimientos" class="details-btn btn-azul">
            Manual de Procedimientos
          </button>
          <button id="btn-manual-usuario" class="details-btn btn-verde">
            Manual de Usuario
          </button>
        </div>

        <button id="btn-cerrar-detalles" class="details-btn btn-rojo">
          Cerrar
        </button>
      </div>
    </div>

    <div class="org-container">
      <header id="custom-filters">
        <div>
          <select id="linea-negocio-select" class="control-select">
            <option value="todos">TODA L√çNEA DE NEGOCIOS</option>
          </select>

          <select id="centro-costos-select" class="control-select">
            <option value="todos">TODO CENTRO COSTOS</option>
          </select>

          <select id="departamento-select" class="control-select">
            <option value="todos">TODOS LOS DEPARTAMENTOS</option>
          </select>
          <select id="modo-select" class="control-select">
            <option value="Persona">VISTA POR PERSONA</option>
            <option value="Cargo">VISTA POR CARGO</option>
          </select>
          <select id="nivel-select" class="control-select" multiple="multiple">
            <!-- TODO: CORREGIR LOS NOMBRES DE LOS NIVELES -->
            <!-- <option value="0">0. Supervisi√≥n y ejecuci√≥n</option> -->
            <option value="1">1. Alta Direcci√≥n</option>
            <option value="2">2. Nivel Gerencial</option>
            <option value="3">3. Gerentes Corporativo/Producci√≥n</option>
            <option value="4">4. Gerentes de Plantas/Retail/ Contable/Log√≠stica</option>
            <option value="5">5. Nivel Jefaturas</option>
            <option value="6">6. Nivel Jefatura Sistemas</option>
            <option value="7">7. Nivel Coordinaci√≥n/Administraci√≥n</option>
            <option value="8">8. Nivel Supervisi√≥n</option>
            <option value="9">9. Nivel Anal√≠tico</option>
            <option value="10">10. Nivel Operativo/T√©cnico</option>
            <option value="11">11. Nivel Operativo Jr</option>
            <option value="12">12. Nivel Base/Operario</option>
          </select>
        </div>
      </header>

      <main id="tree-container">
        <div id="chart-loader-overlay">
          <div class="loader-spinner"></div>
          <div id="loader-text">Cargando...</div>
        </div>
        <div id="tree"></div>
      </main>
    </div>

    <script>
      // 1. Variable para guardar el usuario
      let receivedUserId = null; // Guardar√° el 'userId' formateado (ej. "interno\drendon")
      let isDataReady = false; // Una "bandera" para saber si 'allNodes' est√° cargado
      let empleadoLogueado = null; // Guardar√° el objeto del empleado una vez encontrado
      let usuarioPuedeVerTodo = false; // Variable global de permiso

      let chart = null;
      let allNodes = []; // Aqu√≠ guardaremos todos los nodos (Estos son los nodos de "Persona")
      let allCargoNodes = []; // Aqu√≠ guardaremos los nodos de "Cargo"
      let isCargoDataReady = false; // Bandera para saber si ya cargamos la data de cargo
      let filteredNodes = [];

      //TODO: Corregir el bug inicial

      // --- Referencias a divs de estado ---
      const loaderOverlay = document.getElementById("chart-loader-overlay");
      const loaderText = document.getElementById("loader-text");
      const statusDiv = document.getElementById("status-message");
      const errorDiv = document.getElementById("error-message");
      const treeDiv = document.getElementById("tree");
      let rangeScaleElement = document.getElementById("range_scale");
      let txtScaleElement = document.getElementById("txt_scale");

      const apiCargoUrl =
        "https://mobileqa.liris.com.ec/delportal/wp-json/delportal/v1/get_organigrama_cargo";

      // --- C√ìDIGO PARA BLOQUEAR ZOOM DEL NAVEGADOR (ESCRITORIO) ---
      // 1. Bloquea el zoom con la rueda del rat√≥n (Ctrl + Rueda)
      window.addEventListener(
        "wheel",
        function (event) {
          // Comprueba si la tecla Ctrl est√° presionada
          if (event.ctrlKey) {
            event.preventDefault(); // Cancela el evento (el zoom)
          }
        },
        { passive: false }
      ); // 'passive: false' es necesario para permitir el preventDefault

      // 2. Bloquea el zoom con el teclado (Ctrl + '+' y Ctrl + '-')
      window.addEventListener("keydown", function (event) {
        // Comprueba si la tecla Ctrl (o Cmd en Mac) est√° presionada
        if (event.ctrlKey || event.metaKey) {
          // Comprueba si la tecla presionada es '+' o '-'
          if (
            event.key === "+" ||
            event.key === "-" ||
            event.key === "=" ||
            event.key === "_"
          ) {
            event.preventDefault(); // Cancela el evento (el zoom)
          }
        }
      });

      // --- C√ìDIGO PARA TRAER EL USERID ---
      // 1. Escucha los mensajes ("postMessage") de la ventana padre
      window.addEventListener("message", (event) => {
        // 3. Comprueba si el mensaje tiene la estructura esperada
        if (event.data && event.data.userId) {
          const userIdLimpio = event.data.userId.toLowerCase();
          console.log("‚úÖ Usuario ID recibido:", userIdLimpio);

          // 1. Formatear y Guardar
          receivedUserId = "interno\\" + userIdLimpio;

          // 2. Intentar procesar (en caso de que la data ya est√© lista)
          procesarLoginDeUsuario();
        }
      });

      /* DetailsForm Personalizado */
      let CustomDetailsForm = function () {
        this.instance = null;
        this.overlay = null;
        this.form = null;
        this.data = null;
      };

      /**
       * M√©todo INIT: Se llama cuando el gr√°fico se inicializa.
       * Aqu√≠ "descubrimos" los elementos del DOM y asignamos los listeners.
       */
      CustomDetailsForm.prototype.init = function (balkanInstance) {
        this.instance = balkanInstance; // Guardamos la instancia del gr√°fico
        this.currentPersonData = null;

        // --- 1. Encontrar los elementos del DOM ---
        this.overlay = document.getElementById("details-overlay");
        this.form = document.getElementById("custom-details-form");

        // Elementos de datos (los guardamos para no buscarlos cada vez)
        this.imgEl = this.form.querySelector("#details-img");
        this.nameEl = this.form.querySelector("#details-name");
        this.puestoEl = this.form.querySelector("#details-puesto");
        this.emailEl = this.form.querySelector('[data-field="email"]');
        this.lineaEl = this.form.querySelector('[data-field="lineaNegocio"]');
        this.costoEl = this.form.querySelector('[data-field="centroCosto"]');
        this.deptoEl = this.form.querySelector('[data-field="departamento"]');

        // Botones
        this.btnFunciones = this.form.querySelector("#btn-manual-funciones");
        this.btnProcedimientos = this.form.querySelector(
          "#btn-manual-procedimientos"
        );
        this.btnUsuario = this.form.querySelector("#btn-manual-usuario");
        this.btnCerrar = this.form.querySelector("#btn-cerrar-detalles");

        // --- 2. Asignar Event Listeners (¬°Solo se hace una vez!) ---
        // Cerrar al hacer clic en el bot√≥n "Cerrar"
        this.btnCerrar.addEventListener("click", () => {
          this.hide();
        });

        // Cerrar al hacer clic FUERA del modal (en el overlay)
        this.overlay.addEventListener("click", (e) => {
          if (e.target === this.overlay) {
            this.hide();
          }
        });

        // Listener para la lista de empleados (usando delegaci√≥n)
        const infoBlock = this.form.querySelector(".details-info-block");
        infoBlock.addEventListener("click", (event) => {
          // 1. Encontrar el '.employee-list-item' m√°s cercano al que se hizo clic
          const item = event.target.closest(".employee-list-item");
          if (!item) return; // No se hizo clic en un item, no hacer nada

          // 2. Obtener el ID del empleado del data-attribute
          const empId = item.dataset.employeeId;
          if (!empId || !this.data || !this.data.listaEmpleados) return;

          // 3. Encontrar la data completa de ese empleado
          const empData = this.data.listaEmpleados.find(
            (e) => e.codigoEmpleado === empId
          );
          if (!empData) return;

          // 4. ¬°Llamar a nuestra funci√≥n helper!
          // Esto re-poblar√° el modal con la informaci√≥n de la persona seleccionada
          const personDataForModal = {
            id: empData.codigoEmpleado,
            nombre: `${empData.nombre || ""} ${empData.apellido || ""}`.trim(),
            puesto: empData.puestoEmpleado || this.data.cargoPuesto,
            img: empData.foto  || "Logo-Liris.png",
            email: empData.emailCorporativo,
            lineaNegocio: this.data.lineaNegocio,
            centroCosto: this.data.centroCosto,
            departamento: this.data.departamento,
            codDepAx: empData.codDepAx,
            codDepartamento: this.data.codDepartamento,
          };
          this.currentPersonData = personDataForModal; // ACTUALIZA LA VARIABLE
          this.fillPersonData(personDataForModal);
        });

        // --- L√≥gica de los botones de Manuales ---
        this.btnFunciones.addEventListener("click", () => {
          const url = getManualUrl(this.currentPersonData, "funciones");
          if (url) {
            window.open(url, "_blank");
          } else {
            alert(
              "No hay un Manual de Funciones configurado para este usuario."
            );
          }
        });

        this.btnProcedimientos.addEventListener("click", () => {
          const url = getManualUrl(this.currentPersonData, "procedimientos");
          if (url) {
            window.open(url, "_blank");
          } else {
            alert(
              "No hay un Manual de Procedimientos configurado para este usuario."
            );
          }
        });

        this.btnUsuario.addEventListener("click", () => {
          const url = getManualUrl(this.currentPersonData, "usuario");
          if (url) {
            window.open(url, "_blank");
          } else {
            alert("No hay un Manual de Usuario configurado para este usuario.");
          }
        });
      };

      /**
       * ¬°NUEVA FUNCI√ìN HELPER REFACTORIZADA!
       * La sacamos de 'show' para poder reutilizarla.
       */
      CustomDetailsForm.prototype.fillPersonData = function (personData) {
        const isVacant = personData.tags && personData.tags.includes("vacante");

        this.nameEl.textContent = personData.nombre;
        this.puestoEl.textContent = personData.puesto;

        // --- L√≥gica de la imagen (corregida para el bug del "flash") ---
        // 1. Configura la 'src' PRIMERO (mientras sigue oculto)
        if (isVacant || !personData.img) {
          this.imgEl.src = "Logo-Liris.png"; //"https://via.placeholder.com/110/cccccc/ffffff?text=N/A";
        } else {
          this.imgEl.src = personData.img  || "Logo-Liris.png";
        }
        // 2. Muestra la imagen AHORA que ya tiene la 'src' correcta
        this.imgEl.style.display = "block"; // Aseg√∫rate de que sea 'block' para centrar
        // --- Fin correcci√≥n flash ---

        // Re-crear el HTML de info de persona
        const infoBlock = this.form.querySelector(".details-info-block");
        let infoHtml = ""; // Empezamos con un string vac√≠o

        infoBlock.innerHTML = `
            <div class="details-info-line">
                <span class="details-info-label">Email:</span>
                <span class="details-info-value">${
                  personData.email || "N/A"
                }</span>
            </div>
            <div class="details-info-line">
                <span class="details-info-label">L√≠nea Negocio:</span>
                <span class="details-info-value">${
                  personData.lineaNegocio || "N/A"
                }</span>
            </div>
            <div class="details-info-line">
                <span class="details-info-label">Centro Costo:</span>
                <span class="details-info-value">${
                  personData.centroCosto || "N/A"
                }</span>
            </div>
            <div class="details-info-line">
                <span class="details-info-label">Departamento:</span>
                <span class="details-info-value">${
                  personData.departamento || "N/A"
                }</span>
            </div>
        `;

        /* 
        // 1. A√±adir Email (solo si existe y no es 'N/A')
        if (personData.email && personData.email !== 'N/A') {
            infoHtml += `
            <div class="details-info-line">
                <span class="details-info-label">Email:</span>
                <span class="details-info-value" data-field="email">${personData.email}</span>
            </div>`;
        }

        // 2. A√±adir L√≠nea Negocio (solo si existe y no es 'N/A')
        if (personData.lineaNegocio && personData.lineaNegocio !== 'N/A') {
            infoHtml += `
            <div class="details-info-line">
                <span class="details-info-label">L√≠nea Negocio:</span>
                <span class="details-info-value">${personData.lineaNegocio}</span>
            </div>`;
        }
        
        // 3. A√±adir Centro Costo (solo si existe y no es 'N/A')
        if (personData.centroCosto && personData.centroCosto !== 'N/A') {
            infoHtml += `
            <div class="details-info-line">
                <span class="details-info-label">Centro Costo:</span>
                <span class="details-info-value">${personData.centroCosto}</span>
            </div>`;
        }

        // 4. A√±adir Departamento (solo si existe y no es 'N/A')
        if (personData.departamento && personData.departamento !== 'N/A') {
            infoHtml += `
            <div class="details-info-line">
                <span class="details-info-label">Departamento:</span>
                <span class="details-info-value">${personData.departamento}</span>
            </div>`;
        }

        // 5. Asignar el HTML construido al bloque
        infoBlock.innerHTML = infoHtml;
        */

        // L√≥gica de botones de manuales
        const canShowManuals =
          personData.id && personData.codDepAx && !isVacant;
        this.btnFunciones.style.display = canShowManuals
          ? "inline-block"
          : "none";
        this.btnProcedimientos.style.display = canShowManuals
          ? "inline-block"
          : "none";
        this.btnUsuario.style.display = canShowManuals
          ? "inline-block"
          : "none";
      };

      /**
       * M√©todo SHOW: Se llama CADA VEZ que se abre el modal.
       * ¬°MANEJA 3 CASOS (Persona, Cargo-Lista, Cargo-Individual)!
       */
      CustomDetailsForm.prototype.show = function (nodeId) {
        // 1. Obtener la data m√°s reciente del nodo
        this.data = this.instance.get(nodeId);
        if (!this.data) return;

        // Resetea la imagen ANTES de cualquier l√≥gica.
        this.imgEl.style.display = "none";
        this.imgEl.src = "";

        const currentMode = document.getElementById("modo-select").value;
        const infoBlock = this.form.querySelector(".details-info-block");

        infoBlock.innerHTML = ""; // Limpiar el contenido anterior del bloque de info

        if (currentMode === "Persona") {
          // ==================================
          // --- VISTA MODO PERSONA ---
          // ==================================
          this.currentPersonData = this.data;
          this.fillPersonData(this.data);
        } else {
          // ==================================
          // --- VISTA MODO CARGO ---
          // ==================================
          const isVacant = this.data.tags.includes("vacante");
          const employeeList = this.data.listaEmpleados;

          if (employeeList && employeeList.length === 1) {
            // --- CASO 1: Cargo con 1 sola persona ---
            const singleEmp = employeeList[0];
            this.currentPersonData = {
              id: singleEmp.codigoEmpleado,
              nombre: `${singleEmp.nombre || ""} ${
                singleEmp.apellido || ""
              }`.trim(),
              puesto: singleEmp.puestoEmpleado || this.data.cargoPuesto,
              img: singleEmp.foto || "Logo-Liris.png",
              email: singleEmp.emailCorporativo,
              lineaNegocio: this.data.lineaNegocio,
              centroCosto: this.data.centroCosto,
              departamento: this.data.departamento,
              codDepAx: singleEmp.codDepAx,
              codDepartamento: this.data.codDepartamento,
            };
            this.fillPersonData(this.currentPersonData);
          } else {
            // --- CASO 2: Cargo con >1 persona O vacante/sin asignar ---
            this.currentPersonData = null;

            this.nameEl.textContent = this.data.cargoPuesto;
            this.puestoEl.textContent = this.data.cargoPersona;

            // Ocultar botones de manuales
            this.btnFunciones.style.display = "none";
            this.btnProcedimientos.style.display = "none";
            this.btnUsuario.style.display = "none";

            // Generar lista de empleados
            if (employeeList && employeeList.length > 1) {
              let employeeHtml = '<div class="details-employee-list">';

              // A√±adimos 'data-employee-id' a cada item
              // 'https://via.placeholder.com/40/cccccc/ffffff?text=N/A'}" class="employee-list-img" alt="">
              employeeList.forEach((emp) => {
                employeeHtml += `
                            <div class="employee-list-item" data-employee-id="${
                              emp.codigoEmpleado
                            }">
                                <img src="${
                                  emp.foto || "Logo-Liris.png"
                                }" class="employee-list-img" alt="">

                                <div class="employee-list-info">
                                    <div class="employee-list-name">${
                                      emp.nombre || ""
                                    } ${emp.apellido || ""}</div>
                                    <div class="employee-list-email">${
                                      emp.emailCorporativo || "Sin email"
                                    }</div>
                                </div>
                            </div>
                        `;
              });
              // --- FIN DEL CAMBIO ---

              employeeHtml += "</div>";
              infoBlock.innerHTML = employeeHtml;
            } else if (isVacant) {
              infoBlock.innerHTML =
                '<div class="details-info-line" style="text-align:center; padding-top:10px;">Este puesto est√° actualmente vacante.</div>';
            } else {
              infoBlock.innerHTML =
                '<div class="details-info-line" style="text-align:center; padding-top:10px;">Este puesto no tiene empleados asignados.</div>';
            }
          }
        }

        // 6. Mostrar el modal (com√∫n para todos)
        this.overlay.classList.add("visible");
      };
      
      /**
       * M√©todo HIDE: Se llama para cerrar el modal.
       */
      CustomDetailsForm.prototype.hide = function () {
        this.overlay.classList.remove("visible");
        this.data = null; // Limpiar la data
      };

      /* FUNCION PARA HABILITAR/DESHABILITAR FILTROS */
      function actualizarEstadoFiltros() {
        const selectIds = "#linea-negocio-select, #centro-costos-select, #departamento-select";
        const $nivel = $("#nivel-select");

        // 1. Verificar valores de los filtros principales
        const linea = $("#linea-negocio-select").val();
        const costo = $("#centro-costos-select").val();
        const depto = $("#departamento-select").val();

        // ¬øHay alg√∫n filtro activo? (Es decir, algo distinto a "todos")
        const hayFiltrosActivos = (linea !== 'todos' || costo !== 'todos' || depto !== 'todos');

        // 2. L√≥gica de Permisos de Usuario (Global)
        if (usuarioPuedeVerTodo) {
          console.log("üîê Permiso Global: SI");
          // Si tiene permiso, habilitamos los filtros principales
          $(selectIds).prop("disabled", false);

          // 3. L√≥gica de Dependencia para Niveles:
          // El nivel solo se habilita si NO hay filtros activos (todo est√° en "todos")
          if (!hayFiltrosActivos) {
             $nivel.prop("disabled", false);
          } else {
             // Si filtr√≥ por Dpto/L√≠nea, bloqueamos el nivel
             $nivel.prop("disabled", true);
             
             // OPCIONAL: Al bloquear, seleccionamos "TODOS" los niveles autom√°ticamente
             // para evitar que el filtro de nivel oculte datos del departamento seleccionado.
             // (Si prefieres que se mantenga la selecci√≥n anterior, borra estas 4 l√≠neas siguientes)
             var allOptions = [];
             $nivel.find('option').each(function() { allOptions.push(this.value); });
             $nivel.val(allOptions).trigger('change'); 
          }

        } else {
          // Si NO tiene permiso (es bodeguero, etc), se deshabilita TODO
          console.log("üîê Permiso Global: NO");
          $(selectIds).prop("disabled", true);
          $nivel.prop("disabled", true);
        }

        // 4. Notificar a Select2 para refrescar la visualizaci√≥n (grisado)
        $(selectIds).trigger("change.select2");
        $nivel.trigger("change.select2");
      }

      /* FUNCION PARA ITERAR AL MOMENTO DE COLAPSAR NODOS */
      function iterate(c, n, collapseIds, excludeId) {
        if (excludeId != n.id) {
          collapseIds.push(n.id);
        }
        if (n.childrenIds) {
          for (var i = 0; i < n.childrenIds.length; i++) {
            iterate(c, c.getNode(n.childrenIds[i]), collapseIds, excludeId);
          }
        }
      }

      // El nuevo icono de "Contraer Todo" (flechas hacia adentro)
      let collapse_all = `<svg fill="#7A7A7A" width="800px" height="800px" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg">
              <path d="M11.493 8.757l-3.454-3.453-2.665 2.665 3.454 3.453-2.59 2.59 7.797 0.004-0.017-7.784-2.525 2.525zM23.172 11.422l3.454-3.453-2.665-2.665-3.454 3.453-2.525-2.525-0.017 7.784 7.797-0.004-2.59-2.59zM8.828 20.578l-3.454 3.453 2.665 2.665 3.454-3.453 2.526 2.525 0.017-7.784-7.797 0.004 2.589 2.59zM25.762 17.988l-7.797-0.004 0.017 7.784 2.525-2.525 3.454 3.453 2.665-2.665-3.454-3.453 2.59-2.59z"></path>
            </svg>`;
      /**
       * Intenta buscar al empleado. Solo se ejecutar√°
       * si 'receivedUserId' Y 'allNodes' est√°n listos.
       */
      function procesarLoginDeUsuario() {
        // Si a√∫n no tenemos los datos, no hacer nada.
        if (!isDataReady) {
          return;
        }

        // 1.1 Harcodeado para pruebas (//TODO:¬°Eliminar en producci√≥n!)
        //*
        if (!receivedUserId) {
          //receivedUserId = "interno\\2300070659"; //Auxiliar
          receivedUserId = "interno\\dromero"; //Asistente de desarrollo
          console.log("Usando usuario interno\\dromero para pruebas");
        } //*/

        // --- üîê INICIO L√ìGICA DE PERMISOS ---
        // 1. Siempre buscamos en 'allNodes' (Vista Persona) para obtener
        //¬† ¬† los datos de permiso (puesto y codPosicion_R)
        let personaDataCompleta = null;
        if (receivedUserId) {
          // Solo si hemos recibido un ID
          personaDataCompleta = allNodes.find(
            (n) => n.userid && n.userid.toLowerCase() === receivedUserId
          );
        }

        if (personaDataCompleta) {
          const puesto = (personaDataCompleta.puesto || "").toLowerCase();
          // Usamos 'codPosicion_R' de la API de Persona
          const codPosReporta = personaDataCompleta.codPosicion_R || null;

          // 2. Aplicar la l√≥gica de permisos que definiste
          const puedeVer =
            puesto.includes("gerente") ||
            puesto.includes("presidente") ||
            puesto.includes("jefe") ||
            puesto.includes("analista de procesos") ||
            puesto.includes("asistente de desarrollo") ||
            puesto.includes("ingeniero de desarrollo") ||
            puesto.includes("analista") ||
            puesto.includes("coordinador") ||
            puesto.includes("administrador") ||
            puesto.includes("auditor") ||
            puesto.includes("auditor senior") ||
            puesto.includes("supervisor") ||
            codPosReporta === "00001" ||
            codPosReporta === null; // Ra√≠z (reporta a '0' o null)

          usuarioPuedeVerTodo = puedeVer; // 3. Actualizar variable global
        } else {
          // Si no se encontr√≥ (ej. usuario 'admin' de WP), default a NO ver todo
          usuarioPuedeVerTodo = false;
        }

        if (usuarioPuedeVerTodo) {
          console.log("üîê Permiso Concedido: Ver Todo");
        } else {
          console.log("üîê Permiso Denegado: Vista Restringida");
        }
        // --- üîê FIN L√ìGICA DE PERMISOS ---

        // Asegurarnos de usar la fuente de datos correcta seg√∫n el modo
        const currentMode = document.getElementById("modo-select").value;
        const sourceNodes = currentMode === "Cargo" ? allCargoNodes : allNodes;

        if (!isDataReady || (currentMode === "Cargo" && !isCargoDataReady)) {
          // Si la data de personas o la data de cargo (seg√∫n la vista) no est√° lista, salimos.
          return;
        }

        // Ahora funciona para ambos modos porque 'userid' est√° en la ra√≠z
        if (currentMode === "Persona") {
          // --- B√∫squeda en Vista por Persona (como antes) ---
          empleadoLogueado = sourceNodes.find((nodo) => {
            return nodo.userid && nodo.userid.toLowerCase() === receivedUserId;
          });
        } else {
          // --- B√∫squeda en Vista por Cargo (NUEVA L√ìGICA) ---
          empleadoLogueado = sourceNodes.find((nodo) => {
            // nodo.listaEmpleados es el array que creamos en el map
            if (!nodo.listaEmpleados || nodo.listaEmpleados.length === 0) {
              return false; // Cargo vacante o sin empleados
            }

            // Usamos .some() para ver si CUALQUIERA de los empleados en la lista coincide
            return nodo.listaEmpleados.some(
              (emp) => emp.userid && emp.userid.toLowerCase() === receivedUserId
            );
          });
        }

        // Evitamos que se ejecute m√∫ltiples veces
        //receivedUserId = null;

        if (empleadoLogueado) {
          console.log(
            "üéâ ¬°Encontrado! Informaci√≥n completa:",
            empleadoLogueado
          );

          // --- ¬°L√ìGICA DE CASCADA INICIAL! ---
          // 1. OBTENER LOS SELECTS
          const selectLinea = document.getElementById("linea-negocio-select");
          const selectCostos = document.getElementById("centro-costos-select");
          const selectDept = document.getElementById("departamento-select");

          // 2. APLICAR L√çNEA
          if (selectLinea && empleadoLogueado.lineaNegocio) {
            selectLinea.value = empleadoLogueado.lineaNegocio;
          }

          // 3. REPOBLAR COSTO (basado en la l√≠nea)
          const nodosParaCostos =
            empleadoLogueado.lineaNegocio === "N/A" ||
            !empleadoLogueado.lineaNegocio
              ? sourceNodes
              : sourceNodes.filter(
                  (n) => n.lineaNegocio === empleadoLogueado.lineaNegocio
                );
          populateSelect(
            "centro-costos-select",
            "centroCosto",
            nodosParaCostos
          );

          // 4. APLICAR COSTO
          if (selectCostos && empleadoLogueado.centroCosto) {
            selectCostos.value = empleadoLogueado.centroCosto;
          }

          // 5. REPOBLAR DEPARTAMENTO (basado en l√≠nea Y costo)
          let nodosParaDeptos = nodosParaCostos; // Empezar con los nodos ya filtrados por l√≠nea
          if (
            empleadoLogueado.centroCosto &&
            empleadoLogueado.centroCosto !== "N/A"
          ) {
            nodosParaDeptos = nodosParaCostos.filter(
              (n) => n.centroCosto === empleadoLogueado.centroCosto
            );
          }
          populateSelect(
            "departamento-select",
            "departamento",
            nodosParaDeptos
          );

          // 6. APLICAR DEPARTAMENTO
          if (selectDept && empleadoLogueado.departamento) {
            selectDept.value = empleadoLogueado.departamento;
          }

          // 7. NOTIFICAR A SELECT2 DE TODOS LOS CAMBIOS (NO DISPARA EVENTO 'change')
          $(selectLinea).trigger("change.select2");
          $(selectCostos).trigger("change.select2");
          $(selectDept).trigger("change.select2");

          // 8. DISPARAR FILTRO FINAL
          // (Solo si el chart ya existe)
          if (chart) {
            console.log(
              "‚ÑπÔ∏è Auto-filtrando el organigrama para el usuario... ",
              empleadoLogueado.userid,
              " en modo: ",
              currentMode
            );
            aplicarFiltrosJerarquicos();
          }
        } else {
          console.warn(
            `‚ö†Ô∏è No se pudo encontrar al usuario '${receivedUserId}' en 'allNodes'.`
          );
          // Si no se encuentra, filtramos por "todos"
          if (chart) {
            aplicarFiltrosJerarquicos();
          }
        }
        //¬† ¬† DESPU√âS de que la cascada haya terminado de poblarlos.
        actualizarEstadoFiltros();
      }

      // --- Funci√≥n Sanitize (para evitar bucles infinitos) ---
      function sanitizeCircularReferences(nodes) {
        const nodeMap = new Map();
        nodes.forEach((node) => {
          if (node && node.id != null) nodeMap.set(node.id, node);
          else {
            console.warn(
              "Sanitizing: Omitiendo nodo inv√°lido durante creaci√≥n de mapa:",
              node
            );
          }
        });

        let loopsBroken = 0;
        console.log("Sanitizing: Iniciando sanitizaci√≥n de bucles...");
        const nodeIds = Array.from(nodeMap.keys());
        for (const nodeId of nodeIds) {
          const startNode = nodeMap.get(nodeId);
          if (!startNode || startNode.pid == null) continue;
          const pathVisited = new Set();
          let currentNode = startNode;
          while (currentNode && currentNode.pid != null) {
            const currentId = currentNode.id;
            const parentId = currentNode.pid;

            // 1. Detectar bucle en esta traza
            if (pathVisited.has(currentId)) {
              console.warn(
                `¬°Bucle detectado! Traza desde ${startNode.id} encontr√≥ un ciclo al volver a ${currentId}. Rompiendo enlace ${currentId} -> ${parentId}`
              );
              currentNode.pid = undefined; // Romper
              loopsBroken++;
              break;
            }
            pathVisited.add(currentId);

            // 2. Verificar si el padre existe en el mapa
            if (!nodeMap.has(parentId)) {
              // console.warn(`Sanitizing: Nodo ${currentId} tiene un pid inv√°lido o faltante: ${parentId}. Tratando nodo como ra√≠z.`);
              currentNode.pid = undefined; // Convertir en ra√≠z
              break;
            }

            currentNode = nodeMap.get(parentId);
            if (!currentNode) {
              console.error(
                "Sanitizing: Error inesperado al obtener el padre",
                parentId
              );
              break;
            }
          }
        }
        console.log(`Sanitizing: Sanitizaci√≥n completa...`);
        return Array.from(nodeMap.values());
      }

      // --- Mapeo de nivelJerarquico a Tag de Subnivel ---
      /* Aplica tags de subnivel (sub-level-X) usando la l√≥gica: (order - orderPadre - 1) */
      function aplicarSubnivelesRelativos(nodos) {
        console.log(
          "Iniciando post-procesamiento de subniveles RELATIVOS AL PADRE..."
        );

        // 1. Crear un mapa para buscar el 'order' de cualquier nodo por su ID
        // Esto es necesario para encontrar el 'order' del padre
        const orderMap = new Map();
        for (const node of nodos) {
          if (node && node.id != null) {
            orderMap.set(node.id, node.order || 99);
          }
        }

        // 2. Iterar todos los nodos para asignar el tag de subnivel
        for (const node of nodos) {
          if (!node.tags) node.tags = []; // Asegurar que 'tags' exista

          let subLevelIndex = 0; // Default para nodos hu√©rfanos
          const pid = node.pid;
          const miOrder = node.order || 99;

          if (pid && orderMap.has(pid)) {
            // Si el nodo tiene un padre que encontramos en el mapa
            const padreOrder = orderMap.get(pid);
            subLevelIndex = miOrder - padreOrder - 1;
          } else if (!pid) {
            // No tiene pid, es un nodo ra√≠z.
            // Asumimos que el "padre" es 0.
            subLevelIndex = miOrder - 0 - 1;
          }

          // Nos aseguramos de que el subnivel no sea negativo
          if (subLevelIndex < 0) {
            subLevelIndex = 0;
          }

          const subLevelTag = `sub-level-${subLevelIndex}`;

          if (!node.tags.includes(subLevelTag)) {
            node.tags.push(subLevelTag);
          }

          // A√±adir el tag para la l√≠nea punteada
          if (subLevelIndex > 0 && !node.tags.includes("sublevel-node")) {
            node.tags.push("sublevel-node");
          }
        }
        console.log("Post-procesamiento de subniveles relativos completado.");
      }

      ///////// * Puebla el <select> con los filtros √∫nicos de los nodos.
      function populateSelect(selectId, dataField, nodes) {
        const selectElement = document.getElementById(selectId);
        if (!selectElement) {
          console.error(`No se encontr√≥ el select con ID: ${selectId}`);
          return;
        }

        // 1. Obtener valores √∫nicos
        const valueSet = new Set();
        nodes.forEach((node) => {
          // Usamos [dataField] para acceder a la propiedad din√°micamente
          if (node[dataField] && node[dataField] !== "N/A") {
            valueSet.add(node[dataField]);
          }
        });

        // 2. Ordenar alfab√©ticamente
        const sortedValues = Array.from(valueSet).sort();

        // 3. Limpiar opciones antiguas (excepto la primera "todos")
        const firstOption = selectElement.options[0];
        selectElement.innerHTML = ""; // Limpiar todo
        if (firstOption) {
          // Volver a a√±adir la opci√≥n "todos"
          selectElement.appendChild(firstOption);
        }

        // 4. Crear y a√±adir <option>
        sortedValues.forEach((value) => {
          const option = document.createElement("option");
          option.value = value;
          option.textContent = value;
          selectElement.appendChild(option);
        });
        // Devolvemos las opciones que encontramos
        return sortedValues;
      }

      ///////// * Reconstruye el √°rbol manteniendo la jerarqu√≠a de los padres.
      function aplicarFiltrosJerarquicos() {
        // 1. Validar que el chart est√© listo
        if (!chart) return;

        const currentMode = document.getElementById("modo-select").value;
        const sourceNodes = currentMode === "Cargo" ? allCargoNodes : allNodes;
        console.log(
          `Aplicando filtros jer√°rquicos en modo '${currentMode}' con ${sourceNodes.length} nodos fuente.`
        );
        if (!sourceNodes.length) return; // No hay datos que filtrar

        // 2. Leer los 4 valores
        const selectedLinea = document.getElementById(
          "linea-negocio-select"
        ).value;
        const selectedCosto = document.getElementById(
          "centro-costos-select"
        ).value;
        const selectedDept = document.getElementById(
          "departamento-select"
        ).value;

        // ‚úÖ NUEVO: Obtener array de niveles (Select2 devuelve un array de strings)
        const selectedNiveles = $("#nivel-select").val() || [];

        // 2. Determinar Nivel de Colapso (Profundidad)
        // Si no hay selecci√≥n o est√°n todos, mostramos todo (o un default seguro)
        // Si hay selecci√≥n, buscamos el n√∫mero m√°s alto.
        let maxLevelToShow = 99; // Default: Mostrar todo
        
        if (selectedNiveles.length > 0 && selectedNiveles.length < 12 && !selectedNiveles.includes('99')) {
            // Convertir a n√∫meros y buscar el m√°ximo
            const nivelesNumericos = selectedNiveles.map(n => parseInt(n)).filter(n => !isNaN(n));
            if (nivelesNumericos.length > 0) {
                // El nivel 0 es profundidad 1, Nivel 1 es prof 2, etc.
                // Sumamos 1 porque 'level' en config es la cantidad de niveles visibles.
                maxLevelToShow = Math.max(...nivelesNumericos) + 1;
            }
        }

        // ‚úÖ ACTUALIZAR CONFIGURACI√ìN DE COLAPSO
        // Esto le dice al gr√°fico: "Expande autom√°ticamente hasta este nivel"
        chart.config.collapse = {
            level: maxLevelToShow,
            allChildren: true 
        };

        // 3. Determinar si el filtro de nivel est√° ACTIVO
        // Est√° activo si hay algo seleccionado, NO incluye el '99' (que usas como 'todos' o 'sin asignar') 
        // y no est√°n seleccionados todos (menos de 12 opciones).
        const isNivelActive = selectedNiveles.length > 0 && !selectedNiveles.includes('99') && selectedNiveles.length < 12;

        // 4. Si todos est√°n en "todos", recargar el √°rbol completo
        if (
          selectedLinea === "todos" &&
          selectedCosto === "todos" &&
          selectedDept === "todos" &&
          !isNivelActive // ‚úÖ Verificamos si el nivel est√° inactivo
        ) {
          chart.load(sourceNodes); // (O 'sanitizedNodes' si es tu fuente de verdad)
          //statusDiv.style.display = "none";
          //loaderOverlay.classList.remove("visible");
          return;
        }

        // --- L√≥gica de Filtro con Jerarqu√≠a (Adaptada) ---
        // 4. Un mapa para buscar nodos por ID
        const nodeMap = new Map(sourceNodes.map((node) => [node.id, node]));
        /* console.log(
          "4. Mapa de nodos creado para filtrado jer√°rquico.",
          nodeMap
        ); */
        // 5. Un mapa para guardar los nodos que S√ç queremos mostrar
        const nodesToShow = new Map();

        // 6. Recorrer TODOS los nodos
        for (const node of sourceNodes) {
          // Comprobar si el nodo cumple con LOS 4 filtros (o si el filtro es "todos")
          const lineaMatch =
            selectedLinea === "todos" || node.lineaNegocio === selectedLinea;
          const costosMatch =
            selectedCosto === "todos" || node.centroCosto === selectedCosto;
          const deptMatch =
            selectedDept === "todos" || node.departamento === selectedDept;

          const nivelMatch = !isNivelActive || selectedNiveles.includes(String(node.order));

          // Si el nodo coincide con todos los filtros activos
          if (lineaMatch && costosMatch && deptMatch && nivelMatch) {
            // Para cada nodo que coincide, a√±adirlo A √âL Y A TODOS SUS PADRES
            let currentNode = node;
            while (currentNode) {
              if (nodesToShow.has(currentNode.id)) {
                break; // Si ya a√±adimos esta rama, paramos
              }
              nodesToShow.set(currentNode.id, currentNode);

              // Subir al padre
              if (currentNode.pid && nodeMap.has(currentNode.pid)) {
                currentNode = nodeMap.get(currentNode.pid);
              } else {
                currentNode = null; // Llegamos a la ra√≠z o a un nodo sin padre en el mapa
              }
            }
          }
        }

        // 7. Convertir el mapa de nodos a mostrar en un array y cargarlo
        filteredNodes = Array.from(nodesToShow.values());
        // console.log("10. Filtrado completo. Nodos a mostrar:", filteredNodes);
        if (filteredNodes.length > 0) {
          chart.load(filteredNodes);
        } else {
          // Si el filtro no devuelve nada, mostrar un gr√°fico vac√≠o
          chart.load([]);
          // alert(
          //   `No se encontraron resultados para esta combinaci√≥n de filtros.`
          // );
        }

        //statusDiv.style.display = "none";
        loaderOverlay.classList.remove("visible");
      }

      /* FUNCION PARA GENERAR URL DE LOS MANUALES */
      function getManualUrl(nodeData, tipo) {
        let carpeta = "";
        if (tipo === "usuario") carpeta = "Manual de usuario";
        if (tipo === "procedimientos") carpeta = "Manual de procedimientos";
        if (tipo === "funciones") carpeta = "Manual de funciones";

        // Recreamos la l√≥gica del depParam
        const codEmp = nodeData.id;
        const codDepAx = nodeData.codDepAx;
        const codDepartamento = nodeData.codDepartamento; // Asumiendo que mapeaste este campo

        const depParam =
          codDepAx && codDepartamento
            ? `${codDepAx}|${codDepartamento}`
            : codDepAx || ""; // Usa codDepAx si codDepartamento falta

        // Comprobar si tenemos los datos m√≠nimos
        // if (!codEmp || !depParam) {
        //     console.warn(`Faltan datos para generar el manual de ${tipo}.`, nodeData);
        //     return null; // No podemos construir la URL
        // }

        //return `http://192.168.127.162/rhh/visor.html?Carpeta=${encodeURIComponent(
        return `https://soporte.liris.com.ec/rhh/visor.html?Carpeta=${encodeURIComponent(
          carpeta
        )}&CodEmp=${codEmp || ""}&DepartMyProcessId=${depParam}`;
      }

      // --- Funci√≥n Principal: Cargar, Mapear y Renderizar ---
      async function loadAndRenderChart(apiUrl) {
        loaderOverlay.classList.add("visible");
        loaderText.innerText = "Cargando Organigrama...";
        // Resetea el spinner y el color por si hubo un error antes
        loaderText.style.color = "#555";
        loaderOverlay.querySelector(".loader-spinner").style.display = "block";
        treeDiv.innerHTML = "";

        try {
          // 1. Fetch API
          console.log("Iniciando fetch a:", apiUrl);
          const response = await fetch(apiUrl);
          if (!response.ok)
            throw new Error(
              `Error HTTP ${response.status}: ${response.statusText}`
            );
          console.log(`API respondi√≥ (${response.status}). Procesando...`);
          const apiResponse = await response.json();
          const flatApiData = Array.isArray(apiResponse?.Persona)
            ? apiResponse.Persona
            : null;
          if (!Array.isArray(flatApiData))
            throw new Error(
              "Formato inv√°lido. No se encontr√≥ array en 'Persona'."
            );
          if (flatApiData.length === 0) {
            loaderText.innerText = "API OK, pero no hay datos.";
            return;
          }
          //loaderText.innerText = `Datos recibidos (${flatApiData.length}). Procesando...`;

          // 2. Pre-c√°lculo Mapa Posici√≥n -> Empleado (L√≥gica clave de la jerarqu√≠a de personas)
          const positionToEmployeeMap = new Map();
          flatApiData
            .filter(
              (emp) =>
                emp &&
                emp.codigoPosicion != null &&
                emp.vacante !== "1" &&
                emp.codigoEmpleado
            )
            .forEach((emp) => {
              const positionId = String(emp.codigoPosicion).trim();
              const employeeId = String(emp.codigoEmpleado).trim();
              if (!positionToEmployeeMap.has(positionId)) {
                positionToEmployeeMap.set(positionId, employeeId);
              } else {
                //console.warn(`Advertencia: Posici√≥n ${positionId} asignada a m√∫ltiples empleados. Usando ${positionToEmployeeMap.get(positionId)}.`);
              }
            });
          console.log(
            `Mapa Posici√≥n->Empleado creado con ${positionToEmployeeMap.size} entradas.`
          );

          // 3. Transformaci√≥n (L√≥gica H√≠brida: IDs de Empleado + IDs de Posici√≥n para vacantes)
          const balkanNodes = flatApiData
            .filter(
              (emp) =>
                emp &&
                //emp.codigoPosicion != null &&
                emp.codigoPosicion != "00006" &&
                emp.codigoPosicionReporta != "00424" &&
                emp.puesto != null
              //!(emp.codigoPosicionReporta === "00003" && emp.vacante === "1")
              /*&&
                        String(emp.codigoPosicion).trim() !== "00006" &&
                        // Filtramos solo el departamento de Sistemas y Directorio
                        (emp.nombreDepartamento === "SISTEMAS" || emp.nombreDepartamento === "DIRECTORIO" 
                            || emp.nombreDepartamento === "IMPORTACIONES" || emp.nombreDepartamento === "LEGAL" 
                            || emp.nombreDepartamento === "PROCESOS Y PROYECTOS" 
                            //|| emp.nombreDepartamento === null
                            || (emp.nombreDepartamento === "FINANZAS" && emp.nombreCentroCosto === "DERIVADOS"))
                        */
            )
            .map((emp) => {
              const isVacant = emp.vacante === "1";

              // ID H√çBRIDO: Usamos codigoEmpleado si existe, si no, codigoPosicion
              const id = isVacant
                ? String(emp.codigoPosicion).trim()
                : String(emp.codigoEmpleado).trim();
                
              const CodEmpleado = isVacant
                ? parseInt(emp.codigoPosicion)
                : parseInt(emp.codigoEmpleado);

              let pid = emp.codigoPosicionReporta
                ? String(emp.codigoPosicionReporta).trim()
                : null;

              if (pid && pid !== "0") {
                // El 'pid' SIEMPRE es una POSICI√ìN.
                // Buscamos a qu√© 'id' (empleado o posici√≥n) corresponde.
                const managerEmployeeId = positionToEmployeeMap.get(pid);

                if (managerEmployeeId) {
                  // Encontrado: El jefe (empleado) es el pid.
                  pid = managerEmployeeId;
                } else {
                  // No encontrado: El jefe est√° vacante, el 'pid' es la POSICI√ìN del jefe.
                  pid = pid; // Se mantiene como codigoPosicion
                }

                if (pid === id) pid = undefined; // Evitar auto-referencia
              } else {
                pid = undefined; // Es ra√≠z
              }

              // L√≥gica de Tags (L√≥gica de estilo)
              const levelTag = `level-${emp.nivelJerarquico || "99"}`; // Tag para CSS
              let tags = [levelTag];
              const order = parseInt(emp.nivelJerarquico || 99);

              // Crear el objeto del nodo
              if (isVacant) {
                tags.push("vacante");
                return {
                  id,
                  pid,
                  tags,
                  order,
                  CodEmpleado,
                  // Esto pondr√° "PUESTO VACANTE" en la l√≠nea principal
                  nombre: "PUESTO VACANTE",

                  // Esto pondr√° el nombre del puesto (ej. "DIRECTOR...") en la segunda l√≠nea
                  puesto: emp.puesto || "Puesto N/A", // Usamos 'N/A' como default

                  // --- Rellenar el resto de campos para filtros y consistencia ---
                  codPosicion: emp.codigoPosicion || "N/A",
                  codPosicion_R: emp.codigoPosicionReporta || "N/A",

                  // Importante para que los filtros jer√°rquicos no fallen
                  departamento: emp.nombreDepartamento || "N/A",
                  lineaNegocio: emp.nombreLineaNegocio || "N/A",
                  centroCosto: emp.nombreCentroCosto || "N/A",

                  // Campos de empleado que deben estar nulos
                  userid: null,
                  img: null,
                  email: null,
                  rutaManual: null,
                };
              } else {
                return {
                  id,
                  pid,
                  tags,
                  CodEmpleado,
                  nombre: `${emp.nombre || "N/A"} ${emp.apellido || ""}`.trim(),
                  userid: emp.userid || "UserId no definido",
                  puesto: emp.puesto || "Puesto N/A", // Usamos 'N/A' como default
                  codPosicion:
                    emp.codigoPosicion || "C√≥digo de posici√≥n no definido",
                  codPosicion_R:
                    emp.codigoPosicionReporta ||
                    "C√≥digo de posici√≥n que reporta no definido",
                  lineaNegocio: emp.nombreLineaNegocio || "N/A",
                  centroCosto: emp.nombreCentroCosto || "N/A",
                  departamento: emp.nombreDepartamento || "N/A", //
                  img: emp.foto || "Logo-Liris.png",
                  //"https://via.placeholder.com/60/cccccc/ffffff?text=N/A",
                  email: emp.emailCorporativo || "Sin correo electr√≥nico",
                  rutaManual: emp.rutaManual || "Sin manual asignado",

                  codDepAx: emp.codDepAx || null,
                  codDepartamento: emp.codigoDepartamento || null, //TODO: en la api de personas no tienen codigoDepartamento
                  order,
                };
              }
            })
            .filter(Boolean); // Filtrar nulos si los hubiera

          console.log(`Transformaci√≥n completa (${balkanNodes.length} nodos).`);

          // 4. Sanitizaci√≥n
          const sanitizedNodes = sanitizeCircularReferences(balkanNodes);
          aplicarSubnivelesRelativos(sanitizedNodes);

          allNodes = sanitizedNodes; // Guarda todos los nodos globalmente
          if (sanitizedNodes.length === 0)
            throw new Error("No hay nodos v√°lidos despu√©s de sanitizar.");
          console.log("Nodos sanitizados:", sanitizedNodes);

          isDataReady = true;

          // Poblamos los selects para filtrar por L√≠nea de Negocio, Centro de Costos y Departamento
          populateSelect(
            "linea-negocio-select",
            "lineaNegocio",
            sanitizedNodes
          );
          populateSelect("centro-costos-select", "centroCosto", sanitizedNodes);
          populateSelect("departamento-select", "departamento", sanitizedNodes);

          // 4.1 Intentar procesar (en caso de que el 'userId' ya haya llegado)
          //procesarLoginDeUsuario();
          //console.log(allNodes);

          // 5. Definir Plantillas
          // Plantilla base 'Ficha'
          OrgChart.templates.fichaTemplate = Object.assign(
            {},
            OrgChart.templates.base
          );
          OrgChart.templates.fichaTemplate.size = [250, 110]; // Keep the increased height
          OrgChart.templates.fichaTemplate.editFormHeaderColor = "#F57C00"; // Color del header del editForm
          // Definimos un gradiente en las definiciones SVG
          OrgChart.templates.fichaTemplate.defs += `
                    <linearGradient id="fichaGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#FFFFFF;stop-opacity:1" />  
                        <stop offset="100%" style="stop-color:#FFEFFF;stop-opacity:1" /> 
                    </linearGradient>`;
          // Usamos el gradiente en el nodo
          OrgChart.templates.fichaTemplate.node =
            '<rect x="0" y="0" width="250" height="110" fill="url(#fichaGradient)" stroke="#FDBE86" rx="6" ry="6"></rect>'; // Stroke naranja m√°s suave
          // Barra de acento vertical a la izquierda
          ('<path d="M0 6 L 0 104 Q 0 110 6 110 L 6 110 Q 0 110 0 104 L 0 6 Q 0 0 6 0 L 6 0 Q 0 0 0 6 Z" fill="#F57C00"></path>'); // Naranja principal de Liris?

          OrgChart.templates.fichaTemplate.img_0 =
            '<clipPath id="{randId}"><circle cx="40" cy="55" r="30"></circle></clipPath>' +
            '<image preserveAspectRatio="xMidYMid slice" clip-path="url(#{randId})" xlink:href="{val}" x="10" y="25" width="60" height="60"></image>';

          // --- Ajustar foreignObject y a√±adir ellipsis ---
          OrgChart.templates.fichaTemplate.field_0 = // Nombre
            '<foreignObject x="85" y="25" width="155" height="40">' + // Contenedor
            // Div interno: auto height, max-height for 2 lines approx, ellipsis
            '<div xmlns="http://www.w3.org/1999/xhtml" style="font-size: 14px; font-weight: bold; color: #D35400; line-height: 1.2; height: auto; max-height: 34px; /* Approx 2 lines */ overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; text-align: left;">' +
            "{val}" +
            "</div>" +
            "</foreignObject>";

          OrgChart.templates.fichaTemplate.field_1 = // Puesto
            '<foreignObject x="85" y="60" width="155" height="30">' + // Contenedor
            // Div interno: similar adjustments for ellipsis
            '<div xmlns="http://www.w3.org/1999/xhtml" style="font-size: 11px; color: #797D7F; line-height: 1.2; height: auto; max-height: 27px; /* Approx 2 lines */ overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; text-align: left;">' +
            "{val}" +
            "</div>" +
            "</foreignObject>";

          OrgChart.templates.fichaTemplate.field_2 =
            /* ... (bot√≥n sin cambios) ... */
            '<rect x="85" y="88" width="70" height="18" fill="#4285F4" rx="4" ry="4"></rect>' +
            '<text style="font-size: 10px; cursor: pointer;" fill="#ffffff" x="120" y="100" text-anchor="middle">{val}</text>';

          OrgChart.templates.fichaTemplate.plus = `<circle cx="15" cy="15" r="15" fill="#ffffff" stroke="#aeaeae" stroke-width="1"></circle>
                    <text text-anchor="middle" style="font-size: 18px;cursor:pointer;" fill="#757575" x="15" y="22">{children-count}</text>`;
          OrgChart.templates.fichaTemplate.minus = `<circle cx="15" cy="15" r="15" fill="#ffffff" stroke="#aeaeae" stroke-width="1"></circle>
                    <text text-anchor="middle" style="font-size: 18px;cursor:pointer;" fill="#757575" x="15" y="22">{children-count}</text>`;

          OrgChart.templates.fichaTemplate.ripple = {
            radius: 15,
            color: "#F57C00",
            rect: { x: 0, y: 0, width: 250, height: 110, rx: 15, ry: 15 },
          }; // Ripple effect, al dar click en el nodo da un efecto visual

          // 1. Clonamos la plantilla 'fichaTemplate' para heredar su tama√±o y forma
          OrgChart.templates.vacanteTemplate = Object.assign(
            {},
            OrgChart.templates.fichaTemplate
          );

          // 2. Definimos el fondo oscuro (SVG)
          OrgChart.templates.vacanteTemplate.node =
            '<rect x="0" y="0" height="{h}" width="{w}" fill="#4a4a4a" rx="5" ry="5"></rect>';

          // 3. Nos aseguramos de que no muestre imagen
          OrgChart.templates.vacanteTemplate.img_0 = ""; // Sin imagen

          // 4. Definimos los campos con texto blanco y CENTRADOS
          OrgChart.templates.vacanteTemplate.field_0 = // Puesto
            '<foreignObject x="10" y="30" width="230" height="40">' + // x=10, ancho=230 (m√°rgenes de 10px en nodo de 250px)
            '<div xmlns="http://www.w3.org/1999/xhtml" style="font-size: 16px; font-weight: bold; color: #ffffff; line-height: 1.2; height: auto; max-height: 38px; text-align: center; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">' +
            "{val}" +
            "</div>" +
            "</foreignObject>";

          OrgChart.templates.vacanteTemplate.field_1 = // "PUESTO VACANTE"
            '<foreignObject x="10" y="75" width="230" height="20">' +
            '<div xmlns="http://www.w3.org/1999/xhtml" style="font-size: 14px; font-style: italic; color: #e0e0e0; line-height: 1.2; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">' +
            "{val}" +
            "</div>" +
            "</foreignObject>";

          // 5. ¬°IMPORTANTE! Matamos el field_2
          OrgChart.templates.vacanteTemplate.field_2 = "";
          //     OrgChart.templates.vacanteTemplate.field_2 = // "PUESTO VACANTE"
          // '<foreignObject x="10" y="95" width="230" height="20">' +
          // '<div xmlns="http://www.w3.org/1999/xhtml" style="font-size: 14px; font-style: italic; color: #e0e0e0; line-height: 1.2; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">' +
          // '{val}' +
          // '</div>' +
          // '</foreignObject>';

          // --- 2.1 DEFINIR BINDINGS (MAPEOS) ---
          // (Mueve tu binding de persona aqu√≠ para tener ambos)
          const personaBinding = {
            field_0: "nombre",
            field_1: "puesto",
            img_0: "img",
            //column: "order" // jerarqu√≠a
          };

          // Binding para la vista de Cargo
          // Mapea los campos que crearemos en el .map() de cargo
          const cargoBinding = {
            field_0: "cargoPuesto", // Puesto (ej. "GERENTE GENERAL")
            field_1: "cargoPersona", // Persona (ej. "SANTIAGO SAAB")
            field_2: "cargoDepto", // Depto (ej. "DIRECTORIO")
            //column: "order" // jerarqu√≠a
          };

          // --- 2.2 DEFINIR TEMPLATE DE CARGO ---
          // (Clonamos 'fichaTemplate' para heredar el tama√±o y la barra naranja)
          OrgChart.templates.cargoTemplate = Object.assign(
            {},
            OrgChart.templates.fichaTemplate
          );

          // Quitamos la imagen
          OrgChart.templates.cargoTemplate.img_0 = "";

          // Ajustamos los campos de texto (sin foto, movemos todo a la izquierda)
          OrgChart.templates.cargoTemplate.field_0 = // Puesto
            '<foreignObject x="15" y="15" width="220" height="35">' + // y=15, h=35
            '<div xmlns="http://www.w3.org/1999/xhtml" style="font-size: 16px; font-weight: bold; color: #D35400; line-height: 1.2; height: auto; max-height: 34px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; text-align: left;">' +
            "{val}" +
            "</div>" +
            "</foreignObject>";

          OrgChart.templates.cargoTemplate.field_1 = // Persona
            '<foreignObject x="15" y="50" width="220" height="35">' + // y=50 (15+35), h=35
            '<div xmlns="http://www.w3.org/1999/xhtml" style="font-size: 14px; color: #333; line-height: 1.2; height: auto; max-height: 34px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; text-align: left;">' +
            "{val}" +
            "</div>" +
            "</foreignObject>";

          OrgChart.templates.cargoTemplate.field_2 = // Departamento
            '<foreignObject x="15" y="85" width="220" height="20">' + // y=85 (50+35), h=20
            '<div xmlns="http://www.w3.org/1999/xhtml" style="font-size: 12px; font-style: italic; color: #797D7F; line-height: 1.2; text-align: left;">' +
            "{val}" +
            "</div>" +
            "</foreignObject>";

          //OrgChart.templates.cargoTemplate.field_2 = ""; // Departamento

          // 6. Configuraci√≥n de Tags
          const tagsConfig = {
            // Mapeo de tags de JS a la propiedad 'subLevels'
            "sub-level-0": { subLevels: 0, levelSeparation: 20 },
            "sub-level-1": { subLevels: 1, levelSeparation: 20 },
            "sub-level-2": { subLevels: 2, levelSeparation: 20 },
            "sub-level-3": { subLevels: 3, levelSeparation: 20 },
            "sub-level-4": { subLevels: 4, levelSeparation: 20 },
            "sub-level-5": { subLevels: 5, levelSeparation: 20 },
            "sub-level-6": { subLevels: 6, levelSeparation: 20 },
            "sub-level-7": { subLevels: 7, levelSeparation: 20 },
            "sub-level-8": { subLevels: 8, levelSeparation: 20 },
            "sub-level-9": { subLevels: 9, levelSeparation: 20 },
            "sub-level-10": { subLevels: 10, levelSeparation: 20 },
            filter: {
              template: "dot",
            },
            levelSeparation: 20,
            // Tag para la plantilla vacante
            vacante: {
              template: "vacanteTemplate",
              //   nodeBinding: { field_0: "puesto" },
            },

            // Tags vac√≠os solo para que el CSS los pueda seleccionar
            "level-0": {},
            "level-1": {},
            "level-2": {},
            "level-3": {},
            "level-4": {},
            "level-5": {},
            "level-6": {},
            "level-7": {},
            "level-8": {},
            "level-9": {},
            "level-99": {},
            "sublevel-node": {},
          };

          // 7. Inicializar Gr√°fico
          const chartConfig = {
            //Configuraciones generales
            mouseScrool: OrgChart.action.zoom,
            enableSearch: true,
            searchFields: ["nombre", "puesto"],
            template: "fichaTemplate", // Plantilla base fichaTemplate, olivia, ana, etc
            // mode: 'dark',
            layout: OrgChart.normal,
            scaleInitial: OrgChart.match.boundary, // Ajuste autom√°tico al contenedor, se visualiza todo
            //scaleInitial: 1,
            enableAI: false, //true,
            scaleMax: 1, // Por ejemplo, limita la escala m√°xima a 2 (200% de zoom)
            scaleMin: 0.2, // Tambi√©n puedes configurar la escala m√≠nima si lo necesitas
            //pinch: { enable: true }, // Deshabilita el "pinch-to-zoom" en m√≥viles
            nodes: filteredNodes,
            tags: tagsConfig,
            nodeBinding: personaBinding,
            searchFieldsWeight: {
              nombre: 100, //percent
              puesto: 20, //percent
            },

            orderBy: [
                { field: "order", desc: false }, // Primero ordena por Nivel jerarquico (ascendente)
                { field: "puesto", desc: false },    // Luego por id (ascendente)
                { field: "nombre", desc: false },    // Luego por id (ascendente)
            ],
            searchDisplayField: "nombre",
            aiChatTools: [{
                functionName: 'getEmployeeCount',
                functionDescription: 'Esta herramienta se utiliza exclusivamente para **contar el n√∫mero total de empleados o personas** que est√°n actualmente visibles en el organigrama. √ösala cuando el usuario pregunte por la cantidad, el total, el n√∫mero de empleados o personas.',
                functionParameters: {
                    type: "object",
                    properties: {},
                    required: []
                }
            },
            {
                functionName: 'fit',
                functionDescription: 'Ajusta la vista del organigrama para que todo el contenido sea visible en la pantalla. √ösala cuando el usuario pida "ajustar", "encajar", "ver todo el gr√°fico" o "mostrar el gr√°fico completo".',
                functionParameters: {
                    type: "object",
                    properties: {},
                    required: []
                }
            }],
            /* anim: {
                func: OrgChart.anim.inCirc, // Prueba con outSin o outBack para una sensaci√≥n m√°s suave
                duration: 400 // Aumenta la duraci√≥n a 400ms (o m√°s, como 500ms)
            }, */
            /* 
            collapse:{
                level: 2,
                allChildren: true
            },
            expand: {
                nodes: [4281], // Expande el nodo con ID 4281(Daniel Rendon) y sus hijos 
                allChildren: true // Expande todos los hijos del nodo 4281
            }, */
            controls: {
              svg_export: { title: "Exportar a SVG" },
              //png_preview: { title: 'Preview PNG' },
              zoom_in: { title: "Zoom In" },
              zoom_out: { title: "Zoom Out" },
              fit: { title: "Ajustar a la pantalla" },
              // full_screen : { title: "Expand All" },
              expandAll: {
                icon: OrgChart.icon.expand_all(24, 24, "#7A7A7A"),
                title: "Expandir todo",
                onClick: function () {
                  this.expand(null, "all"); // Expande todos los nodos
                  this.fit(); // Ajusta el zoom a la pantalla
                },
              },
              collapseAll: {
                icon: collapse_all,
                //icon: OrgChart.icon.happy(24, 24, "#7A7A7A"), // Puedes usar un icono personalizado o uno existente
                title: "Colapsar todo",
                onClick: function () {
                  // 1. Detectar el modo actual y la fuente de datos
                  const currentMode =
                    document.getElementById("modo-select").value;
                  const sourceNodes =
                    currentMode === "Cargo" ? allCargoNodes : allNodes;
                  if (!sourceNodes || sourceNodes.length === 0) {
                    console.error(
                      "CollapseAll: No hay sourceNodes (allNodes o allCargoNodes) disponibles."
                    );
                    return;
                  }
                  // 2. Encontrar el nodo ra√≠z (el que no tiene pid) en la data FUENTE
                  const rootNode = sourceNodes.find((n) => n.pid === undefined);
                  if (!rootNode) {
                    console.error(
                      "CollapseAll: No se pudo encontrar un nodo ra√≠z (pid === undefined) en sourceNodes."
                    );
                    return;
                  }
                  const id = rootNode.id; // ¬°Este es el ID din√°mico! (ser√° '15' o '00001')

                  var node = chart.getNode(id);
                  var collapseIds = [];
                  iterate(chart, node, collapseIds, id);
                  chart.expandCollapse(id, [], collapseIds); // Colapsa todos los nodos excepto el nodo ra√≠z, en el campo de en medio poner los nodos que tambien van a aparecer
                  chart.setScale(1);
                  chart.center(id, null, true);
                },
              },
              horizontalLayout: {
                icon: OrgChart.icon.layout_normal(24, 24, "#7A7A7A"), // Puedes usar un icono personalizado o uno existente
                title: "Horizontal Layout",
                onClick: function () {
                  chart.setOrientation(
                    OrgChart.orientation.top,
                    null,
                    function () {
                      chart.fit(); // Ajustar despu√©s de la animaci√≥n de orientaci√≥n
                    }
                  );
                },
              },
              verticalLayout: {
                icon: OrgChart.icon.layout_left_offset(24, 24, "#7A7A7A"), // Puedes usar un icono personalizado o uno existente
                title: "Vertical Layout",
                onClick: function () {
                  chart.setOrientation(
                    OrgChart.orientation.left,
                    null,
                    function () {
                      chart.fit(); // Ajustar despu√©s de la animaci√≥n de orientaci√≥n
                    }
                  );
                },
              },
            },

            enableDragDrop: false, // Habilitar drag and drop
            // Ordenar subniveles por 'nivelJerarquico'
            sortSubLevelsSeparately: true,
            compareSubLevels: {
              order: (a, b) => a.order - b.order,
            },
            nodeExtent: { width: 250, height: 110 },
            editUI: new CustomDetailsForm(), // ¬°Aqu√≠ le decimos que use tu nuevo controlador!
            // nodeMenu: { details: { text: "Detalles" } },
            nodeMenu: null, // Deshabilitamos el men√∫ de clic derecho (opcional)

            menu: {
              pdf_export: {
                text: "Export PDF",
                //icon: pdfIcon
              },
              png_export: {
                text: "Export PNG",
                //icon: pngIcon
              },
              svg_export: {
                text: "Export SVG",
                //icon: svgIcon
              },
            },

            //nodeClick: OrgChart.action,
            nodeSeparation: 65,
            //levelSeparation: 120,    // Espacio entre niveles
            siblingSeparation: 100, // Espacio entre nodos hermanos
            // subtreeSeparation: 30
          };

          //PERSONALIZAR IA
          // Aqu√≠ se le pueden dar instrucciones al sistema de IA para que entienda el contexto de la empresa
          OrgChart.AI_SYSTEM_MESSAGES = [
            //"Trabajas para una empresa llamada LIRIS que se dedica desde el balanceado, criadero de pollos hasta su venta y distribuci√≥n a dem√°s de contar con supermercados retail llamado DelPortal en Guayaquil, Ecuador. El organigrama se trata del equipo de trabajo de esta empresa. La oficina de LIRIS queda en Samborondon, Ecuador. Si te piden eliminar, editar o crear un nodo, NO LO HAGAS, este organigrama solo es de visualizaci√≥n.",
            //"Cuando se te pregunte sobre el n√∫mero de empleados, utiliza la herramienta 'getEmployeeCount'."
            "Eres un asistente de RRHH para el Organigrama Interactivo en MiEmpresa.",
            "Tu principal objetivo es ayudar con la informaci√≥n del organigrama.",
            "Cuando el usuario pregunte por el **n√∫mero de empleados, la cantidad de personas o el total de miembros del equipo**, siempre debes usar la herramienta `getEmployeeCount`.",
            "Si el usuario pide **ajustar la vista del gr√°fico o ver todo el contenido**, usa la herramienta `fit`."
          ];
          // OrgChart.AI_SYSTEM_MESSAGES = [
          //   "Eres una IA especializada en analizar y describir un organigrama existente. Trabajas con un organigrama real de la empresa LIRIS, una compa√±√≠a de Ecuador dedicada al balanceado, crianza de pollos, venta, distribuci√≥n y operaci√≥n de supermercados DelPortal. La oficina principal est√° en Samborond√≥n. \
          //   Tu funci√≥n es EXCLUSIVAMENTE interpretar correctamente la informaci√≥n ya existente en el organigrama. \
          //   - No debes crear, alterar, eliminar ni inventar nodos, personas, cargos, departamentos, relaciones ni cantidades. \
          //   - Si el usuario pide crear o modificar algo del organigrama, responde indicando que no est√° permitido y que solo puedes analizar la informaci√≥n disponible. \
          //   - Siempre usa √∫nicamente los datos actuales del organigrama: nombres, cargos, departamentos, l√≠neas jer√°rquicas y niveles. \
          //   - Al responder preguntas sobre cantidades (por ejemplo: cu√°ntas personas hay en un departamento), debes basarte solo en los nodos visibles o cargados en el organigrama, y nunca suponer datos faltantes. \
          //   - Si el usuario pregunta por algo que no aparece en el organigrama, responde que esa informaci√≥n no est√° disponible en la data mostrada. \
          //   - Si una pregunta puede tener m√∫ltiples interpretaciones, pide aclaraci√≥n antes de asumir. \
          //   - Mant√©n las respuestas precisas, verificables y √∫nicamente basadas en el contenido del organigrama."
          // ];

          OrgChart.aiUI.title = "AI for LIRIS S.A."; //
          OrgChart.SEARCH_PLACEHOLDER = "Buscar por nombre o puesto...";
          //OrgChart.SEARCH_RESULT_LIMIT = 5; // Limita la lista a 5 resultados. El valor por defecto es 5. //TODO: consultar si est√° bien
          OrgChart.SEARCH_RESULT_LIMIT = Number.MAX_SAFE_INTEGER;

          /////////////////////////
          chart = new OrgChart(treeDiv, chartConfig);

          //FUNCIONES PARA QUE LA IA UTILICE 
          // TODO: REVISAR QUE FUNCIONES SER√çAN UTILES IMPLEMENTAR
          chart.onAIToolCalls(function(args) {
              for (var toolCall of args.toolCalls) {
                  if (toolCall.FunctionName === 'getEmployeeCount') {
                      // La forma m√°s sencilla de contar todos los nodos es obtener la longitud del objeto chart.nodes
                      let employeeCount = 0;
            
                      // Filtra los nodos visibles para contar solo los que son "empleados"
                      const visibleEmployeeNodes = chart.visibleNodeIds.filter(nodeId => {
                          const node = chart.getNode(nodeId);
                          // Excluye nodos con templateName 'subLevel' y otros que no sean empleados
                          // Aseg√∫rate de que 'fichaTemplate' y 'vacanteTemplate' son tus plantillas de empleados
                          // A√±ade aqu√≠ cualquier otro templateName que NO deba contarse como empleado
                          return node && 
                                node.templateName !== 'subLevel' && 
                                node.templateName !== 'invisibleGroup' && 
                                node.templateName !== 'group'; // A√±ade m√°s si tienes otros tipos de nodos internos
                      });

                      employeeCount = visibleEmployeeNodes.length;

                      toolCall.FunctionResult = `Actualmente hay ${employeeCount} empleados reales visibles en el organigrama.`;
                      console.log(`Resultado de getEmployeeCount (empleados reales visibles): ${toolCall.FunctionResult}`);
                  }
                  // Si tienes otras herramientas, aseg√∫rate de que su l√≥gica tambi√©n est√© aqu√≠
                  else if (toolCall.FunctionName === 'fit') {
                      chart.fit();
                      toolCall.FunctionResult = "El gr√°fico ha sido ajustado a la pantalla.";
                      console.log(`Resultado de fit: ${toolCall.FunctionResult}`); // Depuraci√≥n
                  }
              }
          });


          //CUANDO SE DA CLICK A UN NODO SE MUESTRA LA INFORMACI√ìN DE ESTE EN CONSOLA
          chart.on("click", function (sender, args) {
            // sender es la instancia del gr√°fico
            // args.node.id es el ID del nodo que clickeaste

            // sender.get() obtiene el objeto de datos completo para ese ID
            const nodeData = sender.get(args.node.id);

            console.log("--- üñ±Ô∏è NODO CLICKEADO ---");
            console.log(nodeData);
            console.log("--------------------------");
          });

          //CUANDO SE CIERRA UN NODO SE CIERRAN TODOS LOS NODOS HIJOS Y AL ABRIR VA DE 1 EN 1
          chart.onExpandCollpaseButtonClick((args) => {
            const nodeId = args.id;
            const node = chart.getNode(nodeId);

            if (args.collapsing) {
              // --- L√≥gica de Colapso Profundo ---
              args.cancel = true; // Cancelar el comportamiento predeterminado de OrgChart.js
              let collapseIds = [];

              // Usamos tu funci√≥n 'iterate'
              iterate(chart, node, collapseIds, nodeId);

              // Colapsa los nodos y, una vez completada la animaci√≥n, ajusta la vista
              chart.expandCollapse(nodeId, [], collapseIds);
              //   chart.fit(); // Ajusta el organigrama a la pantalla
            } else {
              // --- L√≥gica de Expansi√≥n Superficial ---
              // L√≥gica para expandir solo los hijos directos y mantener los nietos colapsados
              if (node && node.childrenIds && node.childrenIds.length > 0) {
                args.cancel = true; // Cancelar el comportamiento predeterminado de OrgChart.js

                // Expande el nodo para mostrar solo sus hijos directos
                chart.expand(nodeId, node.childrenIds, function () {
                  // Despu√©s de expandir los hijos directos, colapsa los hijos de esos hijos (nietos)
                  node.childrenIds.forEach((childId) => {
                    const childNode = chart.getNode(childId);
                    if (
                      childNode &&
                      childNode.childrenIds &&
                      childNode.childrenIds.length > 0
                    ) {
                      chart.collapse(childId, "all");
                    }
                  });
                  // Ajusta la vista despu√©s de todas las operaciones de expansi√≥n/colapso
                  //chart.fit(); // Ajusta el organigrama a la pantalla
                });
              } else {
                // Si el nodo no tiene hijos (es una hoja) o no se aplica la l√≥gica de "solo hijos directos",
                // permite la expansi√≥n predeterminada (que no har√° nada visualmente para una hoja)
                // y luego ajusta la vista.
                chart.expand(nodeId, "all");
              }
            }

            // --- L√ìGICA DE FIT ---
            // Lo ejecutamos despu√©s de un breve retraso para que la animaci√≥n termine
            setTimeout(() => {
              chart.center(nodeId, null, null);
            }, 100); // 100ms de retraso

            // Prevenimos el comportamiento por defecto (que "recuerda" el estado)
            return false;
          });

          //TODO: para personalizar los item del search
          // 2. Sobrescribe el m√©todo OrgChart.searchUI.createItem
          //    Este m√©todo es responsable de generar el HTML para cada elemento de la lista de resultados.
          /* OrgChart.searchUI.createItem = function (img, id, first, second) {
              // 'this' dentro de esta funci√≥n se refiere a la instancia de searchUI,
              // que a su vez tiene una referencia a la instancia del gr√°fico.
              const chartInstance = this.instance;
              const nodeData = chartInstance.get(id); // Obt√©n los datos completos del nodo usando su ID

              const name = nodeData.nombre || '';  // Asume que el nombre est√° en el campo 'name'
              const title = nodeData.puesto || ''; // Asume que el puesto est√° en el campo 'title'

              // Retorna el HTML personalizado para el elemento de la lista de b√∫squeda
              return `<tr data-search-item-id="${id}">
                          <td class="boc-search-image-td">
                              <div class="boc-search-img" style="background-image: url(${img})"></div>
                          </td>
                          <td class="boc-search-text-td">
                              <div class="boc-search-nombre">${name}</div>
                              <div class="boc-search-puesto" style="font-size: 0.8em; color: #666;">${title}</div>
                          </td>
                      </tr>`;
          };

          // Opcional: Si quieres mantener el l√≠mite visual de 5 y el scroll,
          // aplica los estilos CSS como se explic√≥ anteriormente.
          // Esto debe hacerse despu√©s de que el gr√°fico est√© listo y los resultados se muestren.
          chart.searchUI.on('show-items', function(sender, args) {
              const searchResultsWrapper = sender.searchTableWrapper;
              if (searchResultsWrapper) {
                  searchResultsWrapper.style.maxHeight = '250px'; // Ajusta esta altura seg√∫n el tama√±o de tus elementos
                  searchResultsWrapper.style.overflowY = 'auto';
                  searchResultsWrapper.style.border = '1px solid #ccc';
                  searchResultsWrapper.style.boxSizing = 'border-box';
                  searchResultsWrapper.style.padding = '5px';
              }
          }); */


          // Se dispara DESPU√âS de que la carga inicial Y
          // la animaci√≥n 'scaleInitial: match.boundary' han terminado.
          chart.on("ready", function () {
            console.log("‚úÖ Gr√°fico 100% listo (onReady). Mostrando UI.");

            // 1. Mostrar los filtros
            document.getElementById("custom-filters").classList.add("ui-ready");

            // 1. Detectar clic en el fondo del documento
            $(document).on('click', function(e) {
                // Si el clic NO fue dentro de un contenedor de select2
                if ($(e.target).closest('.select2-container').length === 0 && 
                    $(e.target).closest('.control-select').length === 0) {
                    $('.control-select').select2('close');
                }
            });

            // 2. Detectar clic ESPEC√çFICO en el SVG del organigrama (Balkan captura eventos)
            // Esto se a√±ade mejor dentro de la configuraci√≥n del chart o en el evento onReady
            // Pero una forma segura y global es escuchar el mousedown en el contenedor
            document.getElementById('tree').addEventListener('mousedown', function(e) {
                // Usamos jQuery para cerrar cualquier select2 abierto
                $('.control-select').select2('close');
            });
          });

          // --- ¬°L√ìGICA PARA CAMBIAR DE VISTA! ---
          // 1. Inicializar Select2 en todos los selects
          // Inicializa los selects de FILTROS (con buscador)
          $(
            "#linea-negocio-select, #centro-costos-select, #departamento-select"
          ).select2({
            width: "240px",
          });
          // Inicializa el select de MODO (SIN buscador)
          $("#modo-select").select2({
            width: "240px",
            minimumResultsForSearch: Infinity, // Esta l√≠nea desactiva el buscador
          });

          //* 
          // --- INICIALIZACI√ìN DEL FILTRO DE NIVEL (MULTI-SELECT) ---
          // Funci√≥n para renderizar la OPCI√ìN (en el dropdown)
          function formatOptionWithCheckbox(option) {
              if (!option.id) { return option.text; } // Placeholder

              var selectedValues = $("#nivel-select").val() || [];
              var isSelected = selectedValues.includes(option.id);

              var $option = $(
                  '<span><input type="checkbox" ' + (isSelected ? 'checked' : '') + ' /> ' + option.text + '</span>'
              );
              return $option;
          }

          var $nivelSelect = $("#nivel-select");

          // Inicializar Select2
          $nivelSelect.select2({
              width: "240px",
              multiple: true,
              placeholder: "TODOS LOS NIVELES", // Este texto se actualizar√°
              templateResult: formatOptionWithCheckbox,
              // templateSelection: LO QUITAMOS para que se muestre el placeholder
              closeOnSelect: false, 
              allowClear: true, 
              escapeMarkup: function (m) { return m; } 
          });

          // ‚úÖ NUEVO: Funci√≥n para validar si se habilita o deshabilita el Nivel
          function validarDependenciaNiveles() {
              var linea = $("#linea-negocio-select").val();
              var costo = $("#centro-costos-select").val();
              var depto = $("#departamento-select").val();
              
              // Solo habilitar si todos los otros filtros est√°n en "todos" Y el usuario tiene permiso global
              if (linea === 'todos' && costo === 'todos' && depto === 'todos' && usuarioPuedeVerTodo) {
                  $nivelSelect.prop("disabled", false);
              } else {
                  $nivelSelect.prop("disabled", true);
                  
                  // Opcional: Si se deshabilita, forzamos a que se marquen TODOS para no ocultar gente
                  // var allValues = [];
                  // $nivelSelect.find('option').each(function() { allValues.push(this.value); });
                  // $nivelSelect.val(allValues).trigger('change.select2');
              }
          }

          // ‚úÖ NUEVO: Seleccionar TODAS las opciones al iniciar
          var allOptions = [];
          $nivelSelect.find('option').each(function() {
              allOptions.push($(this).val());
          });
          $nivelSelect.val(allOptions).trigger('change'); // Esto marca todo visualmente

          // --- EVENTOS PARA SINCRONIZAR CHECKBOXES Y TEXTO ---
          var isProgrammaticUpdate = false;
          var isClearing = false; // Bandera para detectar si se presion√≥ la "X"

          // 1. DETECTAR LIMPIEZA (La "X" general)
          // Interceptamos el evento 'clearing' que ocurre ANTES de borrar los datos.
          $nivelSelect.on('select2:clearing', function (e) {
              // ¬°IMPORTANTE!: Prevenimos que Select2 borre la selecci√≥n visualmente uno por uno
              e.preventDefault();
              
              if (isProgrammaticUpdate) return;
              isProgrammaticUpdate = true;

              // Obtenemos TODOS los valores disponibles en el select (del 0 al 11, etc.)
              var allValues = [];
              $nivelSelect.find('option').each(function() {
                  allValues.push(this.value);
              });

              // Forzamos la selecci√≥n de TODOS inmediatamente
              // Esto har√° que visualmente se marquen todos los checks y el texto diga "TODOS LOS NIVELES"
              $nivelSelect.val(allValues).trigger('change');
              
              console.log("üßπ Limpieza con X detectada: Reseteando a TODOS los niveles.");
              
              isProgrammaticUpdate = false;
              
              // Sincronizamos visualmente los checkboxes (fondo gris y check)
              syncVisualState($(this));
          });

          // 2. Listener Principal: SELECCI√ìN y DESELECCI√ìN
          $nivelSelect.on("select2:select select2:unselect", function (e) {
              // Si es actualizaci√≥n autom√°tica O si estamos limpiando con la X, NO hacemos nada aqu√≠
              if (isProgrammaticUpdate || isClearing) return;

              var optionId = e.params.data.id;
              
              // L√≥gica para niveles num√©ricos (Ignora opciones como 99 si no es n√∫mero)
              var selectedLevel = parseInt(optionId);

              if (!isNaN(selectedLevel)) {
                  isProgrammaticUpdate = true; // Bloqueamos el listener para evitar bucles

                  // Obtenemos los valores que quedan despu√©s del clic
                  // (Nota: en 'unselect', $(this).val() ya no trae el ID clickeado)
                  var currentValsInSelect = $(this).val() || [];
                  
                  // Verificamos si hay niveles SUPERIORES seleccionados
                  // Ej: Si desmarqu√© el 5, pero sigue marcado el 7 en el array
                  var hasHigherLevels = currentValsInSelect.some(function(val) {
                      return parseInt(val) > selectedLevel;
                  });

                  var newValues = [];

                  if (e.type === 'select2:select') {
                      // ‚úÖ CASO A: SELECCI√ìN (Marcar todo hacia abajo)
                      // Si marco el 7 -> [0, 1, ... 7]
                      for (var i = 0; i <= selectedLevel; i++) {
                          newValues.push(String(i));
                      }
                      $(this).select2('close');

                  } else {
                      // ‚úÖ CASO B: DESELECCI√ìN (Toggle inteligente)
                      
                      if (hasHigherLevels) {
                          // ESCENARIO: "Corte en el medio"
                          // Estaba marcado hasta el 7, y desmarqu√© (clic) en el 5.
                          // Interpretaci√≥n: El usuario quiere ver HASTA el 5.
                          // Acci√≥n: Re-seleccionamos el 5 y borramos 6 y 7.
                          for (var i = 0; i <= selectedLevel; i++) {
                              newValues.push(String(i));
                          }
                      } else {
                          // ESCENARIO: "Toggle en la punta"
                          // Estaba marcado hasta el 7, y desmarqu√© (clic) en el 7.
                          // Interpretaci√≥n: El usuario quiere quitar el 7.
                          // Acci√≥n: Dejamos seleccionado hasta el 6.
                          for (var i = 0; i < selectedLevel; i++) {
                              newValues.push(String(i));
                          }
                      }
                      // ‚úÖ NUEVO: Si al desmarcar nos quedamos vac√≠os, SELECCIONAR TODO
                      if (newValues.length === 0) {
                          // Obtenemos todos los valores disponibles en el select (del 1 al 10)
                          $nivelSelect.find('option').each(function() {
                              newValues.push(this.value);
                          });
                      }
                      // Aplicar cambios
                      $(this).val(newValues).trigger('change');
                      isProgrammaticUpdate = false;
                      $(this).select2('close');
                  }

                  // Mantener opciones especiales (como 99) si estaban marcadas
                  /* if (currentValsInSelect.includes('99')) newValues.push('99'); */

                  // Aplicamos los cambios calculados
                  $(this).val(newValues).trigger('change');
                  
                  isProgrammaticUpdate = false; // Liberamos el listener
              }
              
              // Forzar repintado visual (check y fondo gris)
              syncVisualState($(this));
          });

          // 3. Listener para FINALIZAR la limpieza de la "X"
          $nivelSelect.on("select2:clear", function (e) {
              // Ya se borraron los datos internos, ahora limpiamos lo visual
              isProgrammaticUpdate = true; 
              
              // En lugar de limpiar, seleccionamos TODOS
              var allValues = [];
              $nivelSelect.find('option').each(function() {
                  allValues.push(this.value);
              });
              
              // Aplicamos la selecci√≥n completa
              $(this).val(allValues).trigger('change');
              
              isProgrammaticUpdate = false;
              
              // Forzamos la sincronizaci√≥n visual inmediatamente
              syncVisualState($(this));

              /* // Quitar clases visuales y checks
              $('.select2-results__options li').removeClass('select2-results__option--selected').attr('aria-selected', 'false');
              $('.select2-results__options li input[type="checkbox"]').prop('checked', false);
              
              // Restaurar placeholder
              var $searchField = $(this).next('.select2-container').find('.select2-search__field');
              $searchField.attr('placeholder', "TODOS LOS NIVELES");
              
              isProgrammaticUpdate = false;
              isClearing = false; // Apagamos la bandera de limpieza */
          });

          // 4. Listener General (Actualiza Texto Resumen y Gr√°fico)
          $nivelSelect.on("change.select2", function (e) {
              // Sincronizaci√≥n visual
              syncVisualState($(this));

              var selectedData = $(this).select2('data');
              var $searchField = $(this).next('.select2-container').find('.select2-search__field');

              let summaryText = "TODOS LOS NIVELES"; 
              let totalOptions = $nivelSelect.find('option').length;

              if (selectedData && selectedData.length > 0) {
                  if (selectedData.length >= totalOptions) {
                      summaryText = "TODOS LOS NIVELES";
                  } else {
                      // Buscar el nivel m√°ximo seleccionado
                      let maxLvl = 0;
                      selectedData.forEach(d => {
                          let v = parseInt(d.id);
                          if(!isNaN(v) && v > maxLvl) maxLvl = v;
                      });
                      summaryText = "HASTA NIVEL " + maxLvl;
                  }
              } else {
                  // Si por alguna raz√≥n llega vac√≠o (aunque el c√≥digo de arriba lo evita),
                  // mostramos el texto por defecto
                  summaryText = "TODOS LOS NIVELES";
              }
              
              $searchField.attr('placeholder', summaryText);
              
              // Aplicar Filtro al Gr√°fico (siempre, a menos que sea update interno)
              if (!isProgrammaticUpdate) {
                  aplicarFiltrosJerarquicos();
              }
          });
          // Funci√≥n Helper Visual
          function syncVisualState($selectElement) {
              setTimeout(function() {
                  var finalValues = $selectElement.val() || [];
                  $('.select2-results__options li').each(function() {
                      var idAttr = $(this).attr('id'); 
                      if (!idAttr) return;
                      var valueParts = idAttr.split('-');
                      var value = valueParts[valueParts.length - 1];
                      
                      var shouldBeSelected = finalValues.includes(value);
                      
                      // 1. Checkbox
                      $(this).find('input[type="checkbox"]').prop('checked', shouldBeSelected);
                      
                      // 2. Fondo Gris
                      if (shouldBeSelected) {
                          $(this).addClass('select2-results__option--selected');
                          $(this).attr('aria-selected', 'true');
                      } else {
                          $(this).removeClass('select2-results__option--selected');
                          $(this).attr('aria-selected', 'false');
                      }
                  });
              }, 0);
          }
          // --- FIN EVENTOS DE SINCRONIZACI√ìN ---

          console.log("Select2 inicializado por primera vez.");
          procesarLoginDeUsuario();

          // --- ¬°NUEVA L√ìGICA DE LISTENERS (CON CASCADA)! ---
          // 2. Listener para L√çNEA DE NEGOCIO (El principal)
          $("#linea-negocio-select").on("change", function () {
            const selectedLinea = $(this).val();
            const sourceNodes =
              document.getElementById("modo-select").value === "Cargo"
                ? allCargoNodes
                : allNodes;

            // 1. Limpiar Centro de Costo y Departamento
            $("#centro-costos-select").val("todos");
            $("#departamento-select").val("todos");

            // 2. Repoblar Centro de Costo (basado en la l√≠nea)
            const nodosParaCostos =
              selectedLinea === "todos"
                ? sourceNodes // Todos los nodos
                : sourceNodes.filter((n) => n.lineaNegocio === selectedLinea);
            const sortedCostos = populateSelect(
              "centro-costos-select",
              "centroCosto",
              nodosParaCostos
            );
            // 3. Notificar a Select2 del cambio en Costo
            $("#centro-costos-select").trigger("change.select2");

            // --- 4. ¬°L√ìGICA DE AUTO-SELECCI√ìN! ---
            if (sortedCostos.length === 1) {
              // Hay solo 1 costo, auto-seleccionar Y DISPARAR SU 'CHANGE'.
              // El handler de Costo se encargar√° de poblar Depto y aplicar el filtro.
              console.log(
                "Auto-seleccionando Centro de Costo:",
                sortedCostos[0]
              );
              $("#centro-costos-select").val(sortedCostos[0]).trigger("change");
            } else {
              // Hay m√∫ltiples costos (o 0), as√≠ que la cascada se detiene aqu√≠.
              // Debemos poblar manualmente el Depto (basado en "Todos" los costos)
              // y luego aplicar el filtro nosotros mismos.
              console.log(
                "L√≠neaNegocio: M√∫ltiples costos, poblando Depto y aplicando filtro."
              );

              // Nodos para Depto (basado en L√≠nea, pero Costo="todos")
              const nodosParaDeptos =
                selectedLinea === "todos"
                  ? sourceNodes
                  : sourceNodes.filter((n) => n.lineaNegocio === selectedLinea);

              populateSelect(
                "departamento-select",
                "departamento",
                nodosParaDeptos
              );
              $("#departamento-select").trigger("change.select2"); // Notificar a Select2

              // Aplicar el filtro (L√≠nea=Seleccionada, Costo=todos, Depto=todos)
              aplicarFiltrosJerarquicos();
              actualizarEstadoFiltros();
              // ‚úÖ IMPORTANTE: Validar si se debe desbloquear el Nivel ahora
              //validarDependenciaNiveles();
            }
          });

          // 3. Listener para CENTRO DE COSTO
          $("#centro-costos-select").on("change", function () {
            console.log("Filtro Maestro: Centro de Costo cambi√≥.");
            const selectedLinea = $("#linea-negocio-select").val();
            const selectedCosto = $(this).val();
            const sourceNodes =
              document.getElementById("modo-select").value === "Cargo"
                ? allCargoNodes
                : allNodes;

            // 1. Limpiar Departamento
            $("#departamento-select").val("todos");

            // 2. Repoblar SOLO el SIGUIENTE filtro: Departamento (basado en l√≠nea Y costo)
            let nodosParaDeptos = sourceNodes;
            if (selectedLinea !== "todos") {
              nodosParaDeptos = nodosParaDeptos.filter(
                (n) => n.lineaNegocio === selectedLinea
              );
            }
            if (selectedCosto !== "todos") {
              nodosParaDeptos = nodosParaDeptos.filter(
                (n) => n.centroCosto === selectedCosto
              );
            }

            const sortedDeptos = populateSelect(
              "departamento-select",
              "departamento",
              nodosParaDeptos
            );

            // 3. Notificar a Select2
            $("#departamento-select").trigger("change.select2");

            // --- 4. ¬°L√ìGICA DE AUTO-SELECCI√ìN! ---
            if (sortedDeptos.length === 1) {
              // Hay solo 1 depto, auto-seleccionar Y DISPARAR SU 'CHANGE'.
              // El handler de Depto se encargar√° de aplicar el filtro.
              console.log("Auto-seleccionando Departamento:", sortedDeptos[0]);
              $("#departamento-select").val(sortedDeptos[0]).trigger("change");
            } else {
              // Hay m√∫ltiples deptos (o 0), as√≠ que la cascada se detiene aqu√≠.
              // Aplicamos el filtro nosotros mismos.
              console.log("CentroCosto: M√∫ltiples deptos, aplicando filtro.");
              aplicarFiltrosJerarquicos();
             actualizarEstadoFiltros(); // üëà IMPORTANTE
            }

            
          });

          // 4. Listener para DEPARTAMENTO (el m√°s simple)
          $("#departamento-select").on("change", function() {
              aplicarFiltrosJerarquicos();
              actualizarEstadoFiltros(); // üëà IMPORTANTE
          });

          // 5. Listener para MODO (Persona/Cargo)
          $("#modo-select").on("change", function () {
            // Limpia el input de b√∫squeda cada vez que se cambia el modo
            if (chart && chart.searchUI && chart.searchUI.input) {
              chart.searchUI.input.value = "";
            }
            // --- Guardar los filtros actuales ---
            const filtrosGuardados = {
              linea: $("#linea-negocio-select").val(),
              costo: $("#centro-costos-select").val(),
              depto: $("#departamento-select").val(),
              niveles: $("#nivel-select").val() // ‚úÖ GUARDAR NIVELES (Array)
            };
            console.log("Filtros guardados:", filtrosGuardados);

            const vista = $(this).val();
            if (vista === "Persona") {
              console.log("Cambiando a vista: Persona");
              statusDiv.innerText = "Cargando vista de Personas...";
              statusDiv.style.display = "block";

              chart.config.template = "fichaTemplate";
              chart.config.nodeBinding = personaBinding;
              chart.config.searchDisplayField = "nombre";

              const sourceNodes = allNodes;
              /// --- Repoblar y Restaurar Cascada ---
              // 2a. Poblar y restaurar L√çNEA
              populateSelect(
                "linea-negocio-select",
                "lineaNegocio",
                sourceNodes
              );
              $("#linea-negocio-select").val(filtrosGuardados.linea);

              // 2b. Poblar y restaurar COSTO (basado en l√≠nea restaurada)
              const nodosParaCostos =
                filtrosGuardados.linea === "todos"
                  ? sourceNodes
                  : sourceNodes.filter(
                      (n) => n.lineaNegocio === filtrosGuardados.linea
                    );
              populateSelect(
                "centro-costos-select",
                "centroCosto",
                nodosParaCostos
              );
              // Solo restaurar si la opci√≥n a√∫n existe en este set de nodos
              if (
                $(
                  "#centro-costos-select option[value='" +
                    filtrosGuardados.costo +
                    "']"
                ).length > 0
              ) {
                $("#centro-costos-select").val(filtrosGuardados.costo);
              } else {
                filtrosGuardados.costo = "todos"; // Forzar a 'todos' si no se encontr√≥
              }

              // 2c. Poblar y restaurar DEPTO (basado en l√≠nea Y costo restaurados)
              const nodosParaDeptos =
                filtrosGuardados.costo === "todos"
                  ? nodosParaCostos // Nodos ya filtrados por l√≠nea
                  : nodosParaCostos.filter(
                      (n) => n.centroCosto === filtrosGuardados.costo
                    );
              populateSelect(
                "departamento-select",
                "departamento",
                nodosParaDeptos
              );
              // Solo restaurar si la opci√≥n a√∫n existe
              if (
                $(
                  "#departamento-select option[value='" +
                    filtrosGuardados.depto +
                    "']"
                ).length > 0
              ) {
                $("#departamento-select").val(filtrosGuardados.depto);
              }

              // 2d. ‚úÖ RESTAURAR NIVEL
              if (filtrosGuardados.niveles) {
                  $("#nivel-select").val(filtrosGuardados.niveles);
              }

              // 2e. Notificar a Select2 de los cambios
              $(".control-select").trigger("change.select2");

              // 2f. Aplicar los filtros restaurados
              aplicarFiltrosJerarquicos();

              statusDiv.style.display = "none";
              //loaderOverlay.classList.remove("visible");
            } else if (vista === "Cargo") {
              console.log("Cambiando a vista: Cargo");

              chart.config.template = "cargoTemplate";
              chart.config.nodeBinding = cargoBinding;
              chart.config.searchDisplayField = "puesto";

              // Esta funci√≥n ya se encarga de repoblar y filtrar
              loadAndRenderCargoChart(apiCargoUrl, filtrosGuardados);
              chart.config.searchFields = ["cargoPuesto", "cargoPersona"];
            }
            // Esto reaplicar√° el estado (bloqueado o desbloqueado) a los filtros
            // despu√©s de que hayan sido repoblados para la nueva vista.
            actualizarEstadoFiltros();
          });

          chart.searchUI.on("searchclick", function (sender, args) {
            // Oculta el buscador inmediatamente
            sender.hide();

            sender.instance.center(
              args.nodeId,
              {
                anim: true,
                duration: 300, // Duraci√≥n de la animaci√≥n de centrado
              },
              function () {
                // Funci√≥n 'callback': se ejecuta DESPU√âS de centrar
                sender.instance.setScale(1); // Fija el zoom a 100%
              }
            );

            return false; // Previene otros eventos
          });

          chart.onInit(function () {
            //this.aiUI.show(true)
            //this.aiUI.inputElement.value = '¬øQu√© puedes hacer?'
            console.log("Funcionando...", this);

            if (chart.searchUI && chart.searchUI.input) {
              chart.searchUI.input.addEventListener(
                "keydown",
                function (event) {
                  if (event.key === "Enter") {
                    event.preventDefault(); // Previene el env√≠o del formulario

                    const searchTable = chart.searchUI.searchTableWrapper;
                    if (!searchTable) return;

                    // 1. Busca el item SELECCIONADO (el que tiene data-selected="yes")
                    let elementToClick = searchTable.querySelector(
                      'tr[data-selected="yes"]'
                    );

                    if (!elementToClick) {
                      // 2. Si no hay ninguno seleccionado, busca el PRIMER item de la lista
                      // (el primer tr que tenga el atributo data-search-item-id)
                      elementToClick = searchTable.querySelector(
                        "tr[data-search-item-id]"
                      );
                    }

                    // 3. Simula el clic en el elemento encontrado (esto dispara tu 'searchclick')
                    if (elementToClick) {
                      elementToClick.click();
                    }
                  }

                  if (
                    event.key.length === 1 &&
                    event.key >= "0" &&
                    event.key <= "9" &&
                    !event.ctrlKey &&
                    !event.altKey &&
                    !event.metaKey
                  ) {
                    event.preventDefault();
                  }
                }
              );
            }

            /*   Crear y hacer funcionar boton de lupa que muestra el input search  */
            // 1. Encontrar los elementos de Balkan
            const chartContainer = this.element; // El div #tree
            const searchElement = this.element.querySelector(".boc-search");
            const searchInput =
              this.searchUI && this.searchUI.input ? this.searchUI.input : null;
            const menuElement = this.element.querySelector("[data-ctrl-menu]"); // Las 3 rayitas
            if (searchElement && menuElement && searchInput) {
              // 2. Crear nuestro nuevo icono (la lupa)
              const searchIcon = document.createElement("div");
              searchIcon.id = "custom-search-icon";
              searchIcon.title = "Buscar";
              searchIcon.innerHTML = `<svg viewBox="0 0 24 24">
                  <circle cx="11" cy="11" r="8"></circle>
                  <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>`;

              // 3. Insertar nuestro icono en el DOM de Balkan
              // Lo pone justo *antes* del men√∫ de 3 rayitas
              menuElement.parentNode.insertBefore(searchIcon, menuElement);

              // 4. Asignar el evento click al icono
              searchIcon.addEventListener("click", function (e) {
                e.stopPropagation(); // Evitar que el clic se propague
                // 5. Alternar (toggle) la clase que lo hace visible
                const isVisible = searchElement.classList.toggle("is-visible");
                // 6. Si ahora est√° visible, poner el foco en el input
                if (isVisible && searchInput) {
                  searchInput.focus();
                }
              });
              // 7. (Opcional) Ocultar si se hace clic fuera del buscador
              document.addEventListener("click", function (e) {
                // Si el clic NO fue en el buscador Y NO fue en el icono...
                if (
                  !searchElement.contains(e.target) &&
                  !searchIcon.contains(e.target)
                ) {
                  searchElement.classList.remove("is-visible");
                }
              });
            } else {
              console.error(
                "onInit: No se pudieron encontrar los elementos de la UI de Balkan (search, menu, input)."
              );
            }

            // chart.config.scaleInitial = OrgChart.match.boundary;
            // chart._draw(true, OrgChart.action.init, { method: 'fit' });
            //procesarLoginDeUsuario();
            // --- CERRAR SELECT2 AL CLICKEAR EN EL GR√ÅFICO ---
            // Detectamos 'mousedown' en el contenedor del gr√°fico (#tree)
          });

          //   statusDiv.style.display = "none"; // Ocultar "Cargando..."
          loaderOverlay.classList.remove("visible");
        } catch (error) {
          console.error("ERROR DETALLADO:", error);
          loaderText.innerText = "Error.";
          errorDiv.innerText = `Error: ${error.message}. Revisa la consola (F12).`;
          errorDiv.style.display = "block";
        }
      }

      /** Carga, transforma y renderiza la data de CARGOS.    */
      async function loadAndRenderCargoChart(apiUrl, filtrosGuardados = null) {
        // Objeto por defecto si no se pasan filtros
        if (!filtrosGuardados) {
          filtrosGuardados = { linea: "todos", costo: "todos", depto: "todos" };
        }

        // Esta funci√≥n repobla y restaura los filtros para la vista de Cargo
        function poblarYRestaurarFiltrosCargo() {
          const sourceNodes = allCargoNodes; // Fuente de datos para Cargo
          console.log("Restaurando filtros para vista Cargo..."); // 1. Poblar y restaurar L√çNEA

          populateSelect("linea-negocio-select", "lineaNegocio", sourceNodes);
          $("#linea-negocio-select").val(filtrosGuardados.linea); // 2. Poblar y restaurar COSTO

          const nodosParaCostos =
            filtrosGuardados.linea === "todos"
              ? sourceNodes
              : sourceNodes.filter(
                  (n) => n.lineaNegocio === filtrosGuardados.linea
                );
          populateSelect(
            "centro-costos-select",
            "centroCosto",
            nodosParaCostos
          );
          if (
            $(
              "#centro-costos-select option[value='" +
                filtrosGuardados.costo +
                "']"
            ).length > 0
          ) {
            $("#centro-costos-select").val(filtrosGuardados.costo);
          } else {
            filtrosGuardados.costo = "todos"; // Forzar a 'todos' si no se encontr√≥
          } // 3. Poblar y restaurar DEPTO

          const nodosParaDeptos =
            filtrosGuardados.costo === "todos"
              ? nodosParaCostos
              : nodosParaCostos.filter(
                  (n) => n.centroCosto === filtrosGuardados.costo
                );
          populateSelect(
            "departamento-select",
            "departamento",
            nodosParaDeptos
          );
          if (
            $(
              "#departamento-select option[value='" +
                filtrosGuardados.depto +
                "']"
            ).length > 0
          ) {
            $("#departamento-select").val(filtrosGuardados.depto);
          } 
          
          // 4. ‚úÖ RESTAURAR NIVEL
¬† ¬†       if (filtrosGuardados.niveles) {
                $("#nivel-select").val(filtrosGuardados.niveles);
            }

          // 5. Notificar a Select2
          $(".control-select").trigger("change.select2"); // 5. Aplicar filtros

          aplicarFiltrosJerarquicos();
        }

        if (isCargoDataReady) {
          console.log("Datos de Cargos ya cargados. Usando cache.");

          // Simplemente llamamos a la funci√≥n que repuebla y aplica filtros
          poblarYRestaurarFiltrosCargo();
          return; // Salimos de la funci√≥n
        }

        statusDiv.innerText = "Cargando vista de Cargos...";
        statusDiv.style.display = "block";

        try {
          const response = await fetch(apiUrl);
          if (!response.ok) throw new Error(`Error HTTP ${response.status}`);
          const apiResponse = await response.json();

          // Extrae la data de la propiedad "Cargo"
          const flatApiData = Array.isArray(apiResponse?.Cargo)
            ? apiResponse.Cargo
            : null;
          if (!Array.isArray(flatApiData))
            throw new Error(
              "Formato inv√°lido. No se encontr√≥ array en 'Cargo'."
            );

          console.log(
            `Datos de Cargo recibidos (${flatApiData.length}). Procesando...`
          );

          // --- Transformaci√≥n de "Cargo" ---
          const balkanCargoNodes = flatApiData
            .filter(
              (cargo) =>
                cargo &&
                cargo.codigoPosicion != "00006" &&
                cargo.codigoPosicionReporta != "00424" && //Este id no aparece en la api pero si en la viewEmployeers
                //&& !(cargo.codigoPosicionReporta === '00006' && cargo.codigoPosicion !== '00001')
                //&& !['00006', '00416', '00330', '00353'].includes(cargo.codigoPosicion)
                cargo.puesto != null
            ) // Filtro b√°sico
            .map((cargo) => {
              const isVacant = cargo.esVacante === "1";
              const id = String(cargo.codigoPosicion).trim();
              let pid = cargo.codigoPosicionReporta
                ? String(cargo.codigoPosicionReporta).trim()
                : null;

              if (pid === "0" || pid === id) pid = undefined; // Evitar auto-referencia

              // L√≥gica de Tags
              const levelTag = `level-${cargo.nivelJerarquico || "99"}`;
              let tags = [levelTag];

              if (isVacant) {
                tags.push("vacante");
              }

              const order = parseInt(cargo.nivelJerarquico || 99);

              // --- L√ìGICA PARA MANEJAR 'Empleado' (Objeto o Array) ---
              let listaEmpleados = []; // Almacenar√° el array de empleados
              let primerEmpleado = null; // Para datos de manuales
              let cargoPersonaDisplay = "PUESTO VACANTE"; // Nombre para el nodo
              let cargoPersonaImgDisplay;

              let CodEmpleado = null;//999999999; // Valor alto por defecto (para ir al final)

              if (!isVacant && cargo.Empleado) {
                if (
                  Array.isArray(cargo.Empleado) &&
                  cargo.Empleado.length > 0
                ) {
                  // Es un array de empleados
                  listaEmpleados = cargo.Empleado;
                  primerEmpleado = cargo.Empleado[0];
                  cargoPersonaDisplay =
                    listaEmpleados.length === 1
                      ? `${listaEmpleados[0].nombre || ""} ${
                          listaEmpleados[0].apellido || ""
                        }`.trim() // Nombre si es 1
                      : `${listaEmpleados.length} PERSONAS ASIGNADAS`; // Conteo si son m√°s
                  // cargoPersonaDisplay = `${listaEmpleados.length} PERSONAS ASIGNADAS`;
                  // --- L√ìGICA DE ORDENAMIENTO PARA CARGOS ---
                        if (listaEmpleados.length === 1) {
                            // Si hay solo 1, usamos su c√≥digo para ordenar
                            CodEmpleado = parseInt(listaEmpleados[0].codigoEmpleado) || 999999999;
                        } else {
                            // Si hay varios, usamos un valor alto para que vayan al final (pero antes de los vac√≠os si quieres)
                            // O mantenemos el 999999999 para que se agrupen al final junto con otros sin c√≥digo √∫nico
                            CodEmpleado = null;//999999998; // Ejemplo: Un poco antes que los vacantes/sin asignar puros
                        }
                } else if (
                  typeof cargo.Empleado === "object" &&
                  !Array.isArray(cargo.Empleado)
                ) {
                  // Es un solo empleado (objeto)
                  listaEmpleados = [cargo.Empleado];
                  primerEmpleado = cargo.Empleado;
                  cargoPersonaDisplay = `${primerEmpleado.nombre || ""} ${
                    primerEmpleado.apellido || ""
                  }`.trim();
                  cargoPersonaImgDisplay = primerEmpleado.foto;
                  // --- L√ìGICA DE ORDENAMIENTO PARA CARGOS ---
                  // Si es un objeto directo, es un solo empleado
                  CodEmpleado = parseInt(primerEmpleado.codigoEmpleado) || null;//999999999;

                } else {
                  // Es un cargo no vacante pero sin datos de empleado
                  cargoPersonaDisplay = "Sin Asignar";
                }
              } else {
                //cargoPersonaDisplay = cargo.codigoPosicionReporta
              }

              return {
                id,
                pid,
                tags,
                order,
                CodEmpleado,
                // Campos para el template 'cargoTemplate'
                cargoPuesto: cargo.puesto || "Puesto N/A",
                cargoPersona: cargoPersonaDisplay, // "3 PERSONAS ASIGNADAS" o "Nombre Apellido"
                cargoDepto:
                  (primerEmpleado
                    ? primerEmpleado.nombreDepartamento
                    : cargo.nombreDepartamento) || "N/A",
                //cargoDepto: cargo.codigoPosicion,//cargo.nombreDepartamento || "N/A", //WIP: prueba para sabeer codPosicion de la gente

                // Campos para los filtros
                lineaNegocio:
                  (primerEmpleado
                    ? primerEmpleado.nombreLineaNegocio
                    : cargo.nombreLineaNegocio) || "N/A",
                centroCosto:
                  (primerEmpleado
                    ? primerEmpleado.nombreCentroCosto
                    : cargo.nombreCentroCosto) || "N/A",
                departamento:
                  (primerEmpleado
                    ? primerEmpleado.nombreDepartamento
                    : cargo.nombreDepartamento) || "N/A",

                // Guardamos el ARRAY de empleados completo para el modal
                listaEmpleados: listaEmpleados,

                // Campos de 'persona' que la Vista Cargo no usa (los dejamos null)
                nombre: cargoPersonaDisplay,
                puesto: cargo.puesto || "Puesto N/A",
                // img: cargoPersonaImgDisplay,

                // userid: null, //empleado ? empleado.userid : null,

                // Guardamos los datos para los manuales
                codDepAx: primerEmpleado ? primerEmpleado.codDepAx : null,
                codDepartamento: cargo.codDepartamento || null, // El 'codDepartamento' viene del cargo
              };
            });

          // Sanitizar (muy importante)
          const sanitizedCargoNodes =
            sanitizeCircularReferences(balkanCargoNodes);

          console.log(sanitizedCargoNodes);
          // Aplicamos la misma l√≥gica de subniveles relativos
          aplicarSubnivelesRelativos(sanitizedCargoNodes);

          // Cargar la nueva data en el chart
          // 1. Guardar data (ya no se carga todo)
          allCargoNodes = sanitizedCargoNodes;
          isCargoDataReady = true;

          /* console.log(
            `Transformaci√≥n de Cargo completa (${allCargoNodes.length} nodos).`
          ); */

          // Llamamos a la funci√≥n que repuebla y aplica los filtros guardados
          poblarYRestaurarFiltrosCargo();

          statusDiv.style.display = "none";
          //loaderOverlay.classList.remove("visible");
        } catch (error) {
          console.error("ERROR cargando Cargos:", error);
          errorDiv.innerText = `Error cargando Cargos: ${error.message}.`;
          errorDiv.style.display = "block";
        }
      }

      // --- Llamada inicial ---
      document.addEventListener("DOMContentLoaded", function () {
        const apiUrl =
          "https://mobileqa.liris.com.ec/delportal/wp-json/delportal/v1/get_organigrama_persona";
        loadAndRenderChart(apiUrl);
      });
    </script>
  </body>
</html>
