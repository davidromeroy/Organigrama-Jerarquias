<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organigrama LIRIS S.A.</title>
    <script src="Balkan/orgchart.js"></script>
    <!-- <script src="main.js"></script> -->
    <link rel="stylesheet" href="styles.css">

</head>
<body>
    <div id="status-message">Cargando...</div>
    <div id="error-message"></div>
    
    <!-- <div id="custom-filters" style="padding: 10px; background-color: #f0f0f0; text-align: center; ">
        <label for="departamento-select" style="font-family: Arial, sans-serif; margin-right: 10px;"><b>Filtrar por Departamento:</b></label>
        <select id="departamento-select" style="font-size: 16px; padding: 5px;">
            <option value="todos">-- Mostrar Todos --</option>
            </select>
    </div> -->

    <div id="custom-filters">
    <div>
        <select id="linea-negocio-select" class="control-select">
            <option value="todos">Toda L√≠nea Negocio</option>
            </select>

        <select id="centro-costos-select" class="control-select">
            <option value="todos">Todo Centro Costos</option>
            </select>

        <select id="departamento-select" class="control-select">
            <option value="todos">Todos los Deptos.</option>
            </select>
        <select id="modo-select" class="control-select">
            <option value="Persona">Vista por Persona</option>
            <option value="Cargo">Vista por Cargo</option>
            </select>
    </div>
</div>

    <div id="tree" style="width:100%; height: 700px;"></div>

    <!-- <div id="tree"></div> -->
    
    
    <!-- Barra para escala -->
<!--     <input id="range_scale" type="range" min="1" max="100" value="1">
    <div id="txt_scale">1</div> -->


    <script>
        // 1. Variable para guardar el usuario
        //let usuarioId = null;
        let receivedUserId = null;     // Guardar√° el 'userId' formateado (ej. "interno\drendon")
        let isDataReady = false;      // Una "bandera" para saber si 'allNodes' est√° cargado
        let empleadoLogueado = null; // Guardar√° el objeto del empleado una vez encontrado
        // 2. Escucha los mensajes ("postMessage") de la ventana padre
        window.addEventListener("message", (event) => {
            // 3. Comprueba si el mensaje tiene la estructura esperada
            if (event.data && event.data.userId) {
                const userIdLimpio = event.data.userId.toLowerCase();
                console.log("‚úÖ Usuario ID recibido:", userIdLimpio);
                
                // 1. Formatear y Guardar
                receivedUserId = "interno\\" + userIdLimpio;

                // 2. Intentar procesar (en caso de que la data ya est√© lista)
                //procesarLoginDeUsuario();
            }
        });
        
        // --- Referencias a divs de estado ---
        const statusDiv = document.getElementById("status-message");
        const errorDiv = document.getElementById("error-message");
        const treeDiv = document.getElementById("tree");
        let rangeScaleElement = document.getElementById('range_scale');
        let txtScaleElement = document.getElementById('txt_scale');

        // El nuevo icono de "Contraer Todo" (flechas hacia adentro)
        (OrgChart.icon.collapse_all = function (t, e, r, i, n) {
            return (
                null == i && (i = 0),
                null == n && (n = 0),
                `<svg width="${t}" height="${e}" x="${i}" y="${n}" viewBox="0 0 32 32">
                    <path fill="${r}" d="M18.184 26.011l7.785-0.046-0.003-7.735-2.59 2.591-3.454-3.454-2.665 2.665 3.453 3.454-2.526 2.525zM19.921 10.65l3.454-3.455 2.59 2.592 0.003-7.799-7.785 0.018 2.526 2.525-3.454 3.453 2.666 2.666zM12.078 21.367l-3.453 3.454-2.59-2.591-0.004 7.735 7.785 0.046-2.526-2.525 3.454-3.454-2.666-2.665zM8.625 5.195l3.453 3.455 2.666-2.666-3.454-3.453 2.526-2.525-7.785-0.018 0.004 7.799 2.59-2.592z"></path>
                </svg>`
            );
        });

        let chart = null;
        let allNodes = []; // ¬°NUEVO! Aqu√≠ guardaremos todos los nodos
        let sensitivity = 100;
        let colors = ["#F57C00", "#039BE5", "#FFCA28"];
        let filteredNodes = [];
        /**
         * Intenta buscar al empleado. Solo se ejecutar√°
         * si 'receivedUserId' Y 'allNodes' est√°n listos.
         */
        function procesarLoginDeUsuario() {
            
            // Si a√∫n no tenemos el ID o los datos, no hacer nada.
            ///* 
            if (!receivedUserId || !isDataReady) {
                return; 
            } 
            //*/
            
            // 1.1 Harcodeado para pruebas
            //receivedUserId = "interno\\padanaque"; // //
            /* 
            if (!receivedUserId || !isDataReady) {
                receivedUserId = "interno\\dromero";
                console.log('Usuario interno\\dromero para pruebas');
            }
            */
            //receivedUserId = "interno\\dromero"; // //

            empleadoLogueado = allNodes.find(
                nodo => { return nodo.userid && nodo.userid.toLowerCase() === receivedUserId; }
            );

            if (empleadoLogueado) {
                console.log("üéâ ¬°Encontrado! Informaci√≥n completa:", empleadoLogueado);
                // Aqu√≠ es donde puedes auto-filtrar el organigrama:
                // autoFiltrar(empleadoLogueado);
                // ---
                // 1. Obtener los elementos <select>
                const selectLinea = document.getElementById('linea-negocio-select');
                const selectCostos = document.getElementById('centro-costos-select');
                const selectDept = document.getElementById('departamento-select');

                // 2. Asignar los valores a los selects
                //    (Comprobamos que el empleado tenga el dato y que el select exista)
                if (selectLinea && empleadoLogueado.lineaNegocio) {
                    selectLinea.value = empleadoLogueado.lineaNegocio;
                    console.log(`Asignando Linea Negocio: ${empleadoLogueado.lineaNegocio}`);
                }
                if (selectCostos && empleadoLogueado.centroCosto) {
                    selectCostos.value = empleadoLogueado.centroCosto;
                    console.log(`Asignando Centro Costos: ${empleadoLogueado.centroCosto}`);
                }
                if (selectDept && empleadoLogueado.departamento) {
                    selectDept.value = empleadoLogueado.departamento;
                    console.log(`Asignando Departamento: ${empleadoLogueado.departamento}`);
                }
                
                // 3. ¬°IMPORTANTE! Disparar el filtro
                console.log("‚ÑπÔ∏è Auto-filtrando el organigrama para el usuario...");
                aplicarFiltrosJerarquicos();
                

            } else {
                console.warn(`‚ö†Ô∏è No se pudo encontrar al usuario '${receivedUserId}' en 'allNodes'.`);
            }
            // Evitamos que se ejecute m√∫ltiples veces
            receivedUserId = null; 
        }
        
        // --- Funci√≥n Sanitize (para evitar bucles infinitos) ---
        function sanitizeCircularReferences(nodes) {
            const nodeMap = new Map();
            nodes.forEach((node) => { if (node && node.id != null) nodeMap.set(node.id, node); else { console.warn("Sanitizing: Omitiendo nodo inv√°lido durante creaci√≥n de mapa:", node); } });
            
            let loopsBroken = 0;
            console.log("Sanitizing: Iniciando sanitizaci√≥n de bucles...");
            const nodeIds = Array.from(nodeMap.keys());
            for (const nodeId of nodeIds) {
                const startNode = nodeMap.get(nodeId); 
                if (!startNode || startNode.pid == null) continue;
                const pathVisited = new Set(); 
                let currentNode = startNode; 
                while (currentNode && currentNode.pid != null) {
                    const currentId = currentNode.id;
                    const parentId = currentNode.pid; 
                    
                    // 1. Detectar bucle en esta traza
                    if (pathVisited.has(currentId)) {
                        console.warn(
                            `¬°Bucle detectado! Traza desde ${startNode.id} encontr√≥ un ciclo al volver a ${currentId}. Rompiendo enlace ${currentId} -> ${parentId}`
                        );
                        currentNode.pid = undefined; // Romper
                        loopsBroken++;
                        break; 
                    }
                    pathVisited.add(currentId); 
                    
                    // 2. Verificar si el padre existe en el mapa
                    if (!nodeMap.has(parentId)) {
                        // console.warn(`Sanitizing: Nodo ${currentId} tiene un pid inv√°lido o faltante: ${parentId}. Tratando nodo como ra√≠z.`);
                        currentNode.pid = undefined; // Convertir en ra√≠z
                        break;
                    }

                    currentNode = nodeMap.get(parentId); 
                    if (!currentNode) {
                        console.error("Sanitizing: Error inesperado al obtener el padre", parentId);
                        break;
                    }
                }
            }
            console.log(`Sanitizing: Sanitizaci√≥n completa...`);
            return Array.from(nodeMap.values());
        }

        // --- Mapeo de nivelJerarquico a Tag de Subnivel (Tu funci√≥n) ---
        function getSubLevelTag(nivelJerarquico) {
            const nivel = parseInt(nivelJerarquico) -1; // Ajuste para que 1 sea nivel 0
            if (nivel === 5) return "sub-level-1"; // Senior
            if (nivel === 6) return "sub-level-2"; // Junior
            if (nivel === 7) return "sub-level-3"; // Asistente
            return "sub-level-0"; // Otros
        }

        ///////// * Puebla el <select> con los filtros √∫nicos de los nodos.        
        function populateSelect(selectId, dataField, nodes) {
            const selectElement = document.getElementById(selectId);
            if (!selectElement) {
                console.error(`No se encontr√≥ el select con ID: ${selectId}`);
                return;
            }

            // 1. Obtener valores √∫nicos
            const valueSet = new Set();
            nodes.forEach(node => {
                // Usamos [dataField] para acceder a la propiedad din√°micamente
                if (node[dataField] && node[dataField] !== 'N/A') {
                    valueSet.add(node[dataField]);
                }
            });

            // 2. Ordenar alfab√©ticamente
            const sortedValues = Array.from(valueSet).sort();

            // 3. Crear y a√±adir <option>
            sortedValues.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                selectElement.appendChild(option);
            });

            // 4. A√±adir el Event Listener
            selectElement.addEventListener('change', aplicarFiltrosJerarquicos);
        }

        ///////// * Se ejecuta cuando el usuario cambia el valor de CUALQUIER valor de los 3 selects.


        ///////// * Reconstruye el √°rbol manteniendo la jerarqu√≠a de los padres.
        function aplicarFiltrosJerarquicos() {
            // 1. Validar que el chart est√© listo
            // (Asumo que 'chart', 'allNodes' y 'statusDiv' son variables globales en tu script)
            if (!chart || !allNodes.length) return; 

            // 2. Leer los 3 valores
            const selectedLinea = document.getElementById('linea-negocio-select').value;
            const selectedCosto = document.getElementById('centro-costos-select').value;
            const selectedDept = document.getElementById('departamento-select').value;
            
            statusDiv.style.display = "block";
            statusDiv.innerText = "Filtrando...";

            // 3. Si todos est√°n en "todos", recargar el √°rbol completo
            if (selectedLinea === "todos" && selectedCosto === "todos" && selectedDept === "todos") {
                chart.load(allNodes); // (O 'sanitizedNodes' si es tu fuente de verdad)
                statusDiv.style.display = "none";
                return;
            }

            // --- Tu L√≥gica de Filtro con Jerarqu√≠a (Adaptada) ---
            // 4. Un mapa para buscar nodos por ID (tu c√≥digo)
            const nodeMap = new Map(allNodes.map(node => [node.id, node]));
            console.log("4. Mapa de nodos creado para filtrado jer√°rquico.", nodeMap);
            // 5. Un mapa para guardar los nodos que S√ç queremos mostrar (tu c√≥digo)
            const nodesToShow = new Map();

            // 6. Recorrer TODOS los nodos
            for (const node of allNodes) {
                // 7. --- ¬°LA MAGIA EST√Å AQU√ç! ---
                // Comprobar si el nodo cumple con LOS TRES filtros (o si el filtro es "todos")
                const lineaMatch = (selectedLinea === 'todos') || (node.lineaNegocio === selectedLinea);
                const costosMatch = (selectedCosto === 'todos') || (node.centroCosto === selectedCosto);
                const deptMatch = (selectedDept === 'todos') || (node.departamento === selectedDept);
                
                // 8. Si el nodo coincide con todos los filtros activos
                if (lineaMatch && costosMatch && deptMatch) {
                    // 9. Para cada nodo que coincide, a√±adirlo A √âL Y A TODOS SUS PADRES
                    let currentNode = node;
                    while (currentNode) {
                        if (nodesToShow.has(currentNode.id)) {
                            break; // Si ya a√±adimos esta rama, paramos
                        }
                        nodesToShow.set(currentNode.id, currentNode);
                        
                        // Subir al padre
                        if (currentNode.pid && nodeMap.has(currentNode.pid)) {
                            currentNode = nodeMap.get(currentNode.pid);
                        } else {
                            currentNode = null; // Llegamos a la ra√≠z o a un nodo sin padre en el mapa
                        }
                    }
                }
            }

            // 10. Convertir el mapa de nodos a mostrar en un array y cargarlo
            filteredNodes = Array.from(nodesToShow.values());
            console.log("Filtrado completo. Nodos a mostrar:", filteredNodes);            
            if (filteredNodes.length > 0) {
                chart.load(filteredNodes);
            } else {
                // Si el filtro no devuelve nada, mostrar un gr√°fico vac√≠o
                chart.load([]); 
                alert(`No se encontraron resultados para esta combinaci√≥n de filtros.`);
            }
            
            statusDiv.style.display = "none";
        }


        // --- Funci√≥n Principal: Cargar, Mapear y Renderizar ---
        async function loadAndRenderChart(apiUrl) {
            statusDiv.innerText = "Llamando a la API...";
            errorDiv.style.display = "none";
            treeDiv.innerHTML = "";

            try {
                // 1. Fetch API
                console.log("Iniciando fetch a:", apiUrl);
                const response = await fetch(apiUrl);
                statusDiv.innerText = `API respondi√≥ (${response.status}). Procesando...`;
                if (!response.ok) throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
                const apiResponse = await response.json();
                const flatApiData = Array.isArray(apiResponse?.Persona) ? apiResponse.Persona : null;
                if (!Array.isArray(flatApiData)) throw new Error("Formato inv√°lido. No se encontr√≥ array en 'Persona'.");
                if (flatApiData.length === 0) {
                    statusDiv.innerText = "API OK, pero no hay datos.";
                    return;
                }
                statusDiv.innerText = `Datos recibidos (${flatApiData.length}). Procesando...`;

                // 2. Pre-c√°lculo Mapa Posici√≥n -> Empleado (L√≥gica clave de la jerarqu√≠a de personas)
                const positionToEmployeeMap = new Map();
                flatApiData
                    .filter(emp => emp && emp.codigoPosicion != null && emp.vacante !== "1" && emp.codigoEmpleado)
                    .forEach((emp) => {
                        const positionId = String(emp.codigoPosicion).trim();
                        const employeeId = String(emp.codigoEmpleado).trim();
                        if (!positionToEmployeeMap.has(positionId)) {
                            positionToEmployeeMap.set(positionId, employeeId);
                        } else {
                            //console.warn(`Advertencia: Posici√≥n ${positionId} asignada a m√∫ltiples empleados. Usando ${positionToEmployeeMap.get(positionId)}.`);
                        }
                    });
                console.log(`Mapa Posici√≥n->Empleado creado con ${positionToEmployeeMap.size} entradas.`);

                // 3. Transformaci√≥n (L√≥gica H√≠brida: IDs de Empleado + IDs de Posici√≥n para vacantes)
                const balkanNodes = flatApiData
                    .filter(emp => 
                        emp && 
                        emp.codigoPosicion != null &&
                        emp.codigoPosicion != '00006' /*&&
                        String(emp.codigoPosicion).trim() !== "00006" &&
                        // Filtramos solo el departamento de Sistemas y Directorio
                         (emp.nombreDepartamento === "SISTEMAS" || emp.nombreDepartamento === "DIRECTORIO" 
                            || emp.nombreDepartamento === "IMPORTACIONES" || emp.nombreDepartamento === "LEGAL" 
                            || emp.nombreDepartamento === "PROCESOS Y PROYECTOS" 
                            //|| emp.nombreDepartamento === null
                            || (emp.nombreDepartamento === "FINANZAS" && emp.nombreCentroCosto === "DERIVADOS"))
                        */
                    )
                    .map(emp => {
                        
                        const isVacant = emp.vacante === "1";
                        
                        // ID H√çBRIDO: Usamos codigoEmpleado si existe, si no, codigoPosicion
                        const id = isVacant 
                            ? String(emp.codigoPosicion).trim() 
                            : String(emp.codigoEmpleado).trim();
                        
                        let pid = emp.codigoPosicionReporta ? String(emp.codigoPosicionReporta).trim() : null;

                        if (pid && pid !== "0") {
                            // El 'pid' SIEMPRE es una POSICI√ìN.
                            // Buscamos a qu√© 'id' (empleado o posici√≥n) corresponde.
                            const managerEmployeeId = positionToEmployeeMap.get(pid);
                            
                            if (managerEmployeeId) {
                                // Encontrado: El jefe (empleado) es el pid.
                                pid = managerEmployeeId;
                            } else {
                                // No encontrado: El jefe est√° vacante, el 'pid' es la POSICI√ìN del jefe.
                                pid = pid; // Se mantiene como codigoPosicion
                            }
                            
                            if (pid === id) pid = undefined; // Evitar auto-referencia
                        } else {
                            pid = undefined; // Es ra√≠z
                        }

                        // L√≥gica de Tags (Tu l√≥gica de estilo)
                        const subLevelTag = getSubLevelTag(emp.nivelJerarquico);
                        const levelTag = `level-${emp.nivelJerarquico || '99'}`; // Tag para CSS
                        let tags = [levelTag];
                        
                        if (subLevelTag !== "sub-level-0") {
                            tags.push(subLevelTag); // Tag para JS (subLevels)
                            tags.push("sublevel-node"); // Tag para CSS (l√≠nea punteada)
                        }
                        
                        const order = parseInt(emp.nivelJerarquico || 99);

                        // Crear el objeto del nodo
                        if (isVacant) {
                            tags.push('vacante');
                        return { id, pid, tags, order,
                            // Esto pondr√° "PUESTO VACANTE" en la l√≠nea principal
                            nombre: "PUESTO VACANTE", 
                            
                            // Esto pondr√° el nombre del puesto (ej. "DIRECTOR...") en la segunda l√≠nea
                            puesto: emp.puesto || "Puesto N/A", // Usamos 'N/A' como default
                            
                            // --- Rellenar el resto de campos para filtros y consistencia ---
                            codPosicion: emp.codigoPosicion || "N/A",
                            codPosicion_R: emp.codigoPosicionReporta || "N/A",
                            
                            // Importante para que los filtros jer√°rquicos no fallen
                            departamento: emp.nombreDepartamento || 'N/A', 
                            lineaNegocio: emp.nombreLineaNegocio || "N/A",
                            centroCosto: emp.nombreCentroCosto || "N/A", 
                            
                            // Campos de empleado que deben estar nulos
                            userid: null,
                            img: null, 
                            email: null,
                            rutaManual: null
                            };
                        } else {
                            return {
                                id, pid, tags,
                                nombre: `${emp.nombre || 'N/A'} ${emp.apellido || ''}`.trim(),
                                userid: emp.userid || "UserId no definido",
                                puesto: emp.puesto || "Puesto N/A", // Usamos 'N/A' como default
                                codPosicion: emp.codigoPosicion || "C√≥digo de posici√≥n no definido",
                                codPosicion_R: emp.codigoPosicionReporta || "C√≥digo de posici√≥n que reporta no definido",
                                lineaNegocio: emp.nombreLineaNegocio || "N/A",
                                centroCosto: emp.nombreCentroCosto || "N/A",
                                departamento: emp.nombreDepartamento || 'N/A', // 
                                img: emp.foto || 'https://via.placeholder.com/60/cccccc/ffffff?text=N/A',
                                email: emp.emailCorporativo || 'Sin correo electr√≥nico',
                                rutaManual: emp.rutaManual || 'Sin manual asignado',
                                order
                            };
                        }
                    })
                    .filter(Boolean); // Filtrar nulos si los hubiera

                console.log(`Transformaci√≥n completa (${balkanNodes.length} nodos).`);
                
                // 4. Sanitizaci√≥n
                const sanitizedNodes = sanitizeCircularReferences(balkanNodes);
                allNodes = sanitizedNodes; // Guarda todos los nodos globalmente
                statusDiv.innerText = `Datos sanitizados. Renderizando...`;
                if (sanitizedNodes.length === 0) throw new Error("No hay nodos v√°lidos despu√©s de sanitizar.");
                console.log("Nodos sanitizados:", sanitizedNodes);
                
                isDataReady = true;
                
                // Poblamos los selects para filtrar por L√≠nea de Negocio, Centro de Costos y Departamento
                populateSelect('linea-negocio-select', 'lineaNegocio', sanitizedNodes);
                populateSelect('centro-costos-select', 'centroCosto', sanitizedNodes);
                populateSelect('departamento-select', 'departamento', sanitizedNodes); // Tu select existente

                // 4.1 Intentar procesar (en caso de que el 'userId' ya haya llegado)
                //procesarLoginDeUsuario();

                // 5. Definir Plantillas (Tu definici√≥n)
                // Plantilla base 'Ficha'
                OrgChart.templates.fichaTemplate = Object.assign({}, OrgChart.templates.base);
                OrgChart.templates.fichaTemplate.size = [250, 110]; // Keep the increased height
                OrgChart.templates.fichaTemplate.editFormHeaderColor = "#F57C00"; // Color del header del editForm
                // Definimos un gradiente en las definiciones SVG
                OrgChart.templates.fichaTemplate.defs += `
                    <linearGradient id="fichaGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#FFF3E0;stop-opacity:1" />  
                        <stop offset="100%" style="stop-color:#FFE0B2;stop-opacity:1" /> 
                    </linearGradient>`;
                // Usamos el gradiente en el nodo
                OrgChart.templates.fichaTemplate.node =
                    '<rect x="0" y="0" width="250" height="110" fill="url(#fichaGradient)" stroke="#FDBE86" rx="6" ry="6"></rect>'; // Stroke naranja m√°s suave
                    // Barra de acento vertical a la izquierda
                    '<path d="M0 6 L 0 104 Q 0 110 6 110 L 6 110 Q 0 110 0 104 L 0 6 Q 0 0 6 0 L 6 0 Q 0 0 0 6 Z" fill="#F57C00"></path>'; // Naranja principal de Liris?
                
                    OrgChart.templates.fichaTemplate.img_0 = /* ... (sin cambios) ... */
                    '<clipPath id="{randId}"><circle cx="40" cy="55" r="30"></circle></clipPath>' +
                    '<image preserveAspectRatio="xMidYMid slice" clip-path="url(#{randId})" xlink:href="{val}" x="10" y="25" width="60" height="60"></image>';

                // --- CAMBIO: Ajustar foreignObject y a√±adir ellipsis ---
                OrgChart.templates.fichaTemplate.field_0 = // Nombre
                    '<foreignObject x="85" y="25" width="155" height="40">' + // Contenedor
                    // Div interno: auto height, max-height for 2 lines approx, ellipsis
                    '<div xmlns="http://www.w3.org/1999/xhtml" style="font-size: 14px; font-weight: bold; color: #D35400; line-height: 1.2; height: auto; max-height: 34px; /* Approx 2 lines */ overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; text-align: left;">' +
                    '{val}' +
                    '</div>' +
                    '</foreignObject>';

                OrgChart.templates.fichaTemplate.field_1 = // Puesto
                    '<foreignObject x="85" y="60" width="155" height="30">' + // Contenedor
                    // Div interno: similar adjustments for ellipsis
                    '<div xmlns="http://www.w3.org/1999/xhtml" style="font-size: 11px; color: #797D7F; line-height: 1.2; height: auto; max-height: 27px; /* Approx 2 lines */ overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; text-align: left;">' +
                    '{val}' +
                    '</div>' +
                    '</foreignObject>';
                // --- FIN CAMBIO ---

                OrgChart.templates.fichaTemplate.field_2 = /* ... (bot√≥n sin cambios) ... */
                    '<rect x="85" y="88" width="70" height="18" fill="#4285F4" rx="4" ry="4"></rect>' +
                    '<text style="font-size: 10px; cursor: pointer;" fill="#ffffff" x="120" y="100" text-anchor="middle">{val}</text>';
                    
                OrgChart.templates.fichaTemplate.ripple = {
                    radius: 15,
                    color: "#F57C00",
                    rect: { x: 0, y: 0, width: 250, height: 110, rx: 15, ry: 15 }
                };  // Ripple effect, al dar click en el nodo da un efecto visual           


                // En main.js, ANTES de 'const chartConfig'

                // 1. Clonamos tu plantilla 'fichaTemplate' para heredar su tama√±o y forma
                OrgChart.templates.vacanteTemplate = Object.assign({}, OrgChart.templates.fichaTemplate);

                // 2. Definimos el fondo oscuro (SVG)
                // Este es un gris oscuro. Puedes cambiar '#4a4a4a' por el que gustes.
                OrgChart.templates.vacanteTemplate.node = 
                    '<rect x="0" y="0" height="{h}" width="{w}" fill="#4a4a4a" rx="5" ry="5"></rect>';

                // 3. Definimos los campos con texto blanco
                // (Aseg√∫rate que coincidan con los campos de 'fichaTemplate')

                // Campo 'nombre' (field_0)
                OrgChart.templates.vacanteTemplate.field_0 = 
                    '<text style="font-size: 16px; font-weight: bold;" fill="#ffffff" x="125" y="60" text-anchor="middle">{val}</text>';
                    
                // Campo 'puesto' (field_1)
                OrgChart.templates.vacanteTemplate.field_1 = 
                    '<text style="font-size: 14px; font-style: italic;" fill="#e0e0e0" x="125" y="85" text-anchor="middle">{val}</text>';

                // 4. Nos aseguramos de que no muestre imagen
                OrgChart.templates.vacanteTemplate.img_0 = "";

                // 6. Configuraci√≥n de Tags (Tu configuraci√≥n)
                const tagsConfig = {
                    // Mapeo de tags de JS a la propiedad 'subLevels'
                    "sub-level-0": { subLevels: 0 , levelSeparation: 20},
                    "sub-level-1": { subLevels: 1 , levelSeparation: 20}, //Se el puede asignar mas cosas, como template: "ana", etc.
                    "sub-level-2": { subLevels: 2 , levelSeparation: 20},
                    "sub-level-3": { subLevels: 3 },
                    filter: {
                        template: 'dot'
                    },
                    levelSeparation: 20,
                    // Tag para la plantilla vacante
                    "vacante": {
                        template: "vacanteTemplate",
                        nodeBinding: { field_0: "puesto" }
                    },
                    
                    // Tags vac√≠os solo para que el CSS los pueda seleccionar
                    "level-0": {}, "level-1": {}, "level-2": {}, "level-3": {},
                    "level-4": {}, "level-5": {}, "level-6": {}, "level-7": {}, "level-99": {},
                    "sublevel-node": {}
                };

                // 7. Inicializar Gr√°fico (Tu configuraci√≥n)
                const chartConfig =  {
                    //Configuraciones generales
                    mouseScrool: OrgChart.action.zoom,
                    enableSearch: true,
                    template: "fichaTemplate", // Plantilla base fichaTemplate, olivia, ana, etc
                    // mode: 'dark',
                    layout: OrgChart.normal,
                    scaleInitial: OrgChart.match.boundary, // Ajuste autom√°tico al contenedor, se visualiza todo
                    //scaleInitial: 1,
                    enableAI: true,


                    //filterBy: ['title', 'city'],
                    //filterBy: 'all',
                    /* filterBy: {
                        puesto: {
                            // 'GERENTE GENERAL': { checked: true, text: 'Gerente General working'},
                            // 'ANALISTA DE SOPORTE': { checked: false, text: 'Analista not working'},
                        },
                        departamento: {},
                        nombre: {},
                    }, */
                    nodes: filteredNodes,
                    tags: tagsConfig,
                    nodeBinding: {
                        field_0: "nombre",
                        field_1: "puesto",
                        img_0: "img"//,
                        //field_2: function(sender, node) { return "Ver ficha"; }
                    },
                    /* 
                    collapse:{
                        level: 2,
                        allChildren: true
                    },
                    expand: {
                        nodes: [4281], // Expande el nodo con ID 4281(Daniel Rendon) y sus hijos, TODO: cambiar posteriormente 
                        allChildren: true // Expande todos los hijos del nodo 4281
                    }, */
                    //TODO: poner numeros en las burbujas min plus para saber cuantos nodos hijos tiene
                    controls: {
                        pdf_export: { title: 'Export to PDF' },
                        //png_preview: { title: 'Preview PNG' },
                        zoom_in: { title: "Zoom In"},
                        zoom_out: { title: "Zoom Out"},
                        fit: { title: "Fit the chart"},
                        // full_screen : { title: "Expand All" },
                        expandAll: {
                            icon: OrgChart.icon.expand_all(24, 24, "#7A7A7A"),
                            title: "Expandir todo",
                            onClick: function() {
                                this.expand(null, 'all') // Expande todos los nodos
                                chart.center(15); // Centra el organigrama despu√©s de expandir
                                this.fit();
                            }
                        }, 
                        collapseAll: {
                            icon: OrgChart.icon.collapse_all(24, 24, '#7A7A7A'),      //TODO: Mejorar el icono para colapsar                      
                            //icon: OrgChart.icon.happy(24, 24, "#7A7A7A"), // Puedes usar un icono personalizado o uno existente
                            title: "Colapsar todo",
                            onClick: function() {
                                let id = 15
                                var node = chart.getNode(id);
                                var collapseIds = [];
                                iterate(chart, node, collapseIds, id);
                                chart.expandCollapse(id, [], collapseIds);
                                chart.center(15);
                                const fixedCollapseScale = 0.8; 
                                this.setScale(fixedCollapseScale); // Establece la escala a un valor fijo
                            }
                        }, //TODO: Ajustar escala fija al colapsar todo
                        horizontalLayout: { 
                            icon: OrgChart.icon.layout_normal(24, 24, "#7A7A7A"), // Puedes usar un icono personalizado o uno existente
                            title: "Horizontal Layout",
                            onClick: function() {
                                this.setOrientation(OrgChart.orientation.top, null)
                                this.fit(); // Ajusta el organigrama despu√©s de cambiar la orientaci√≥n
                                
                            }
                        },
                        verticalLayout: { 
                            icon: OrgChart.icon.layout_left_offset(24, 24, "#7A7A7A"), // Puedes usar un icono personalizado o uno existente
                            title: "Vertical Layout",
                            onClick: function() {
                                this.setOrientation(OrgChart.orientation.left, null)
                                this.fit(); // Ajusta el organigrama despu√©s de cambiar la orientaci√≥n
                                
                            }
                        },
                    },

                    enableDragDrop: false, // Habilitar drag and drop
                    // Ordenar subniveles por 'nivelJerarquico'
                    sortSubLevelsSeparately: true,
                    compareSubLevels: {
                        order: (a, b) => a.order - b.order
                    },
                    nodeMenu: { details: { text: "Detalles" } },
                    nodeExtent: { width: 250, height: 110 },
                    editForm: { 
                        photoBinding: "img", // the photo property name
                        readOnly: true,
                        titleBinding: "nombre", // a property name
                        focusBinding: "puesto",
                        buttons:  {
                            // Tu bot√≥n personalizado para redirigir
                            goToProfile: {
                                icon: OrgChart.icon.link(24, 24, '#fff'), // Un icono de enlace, por ejemplo
                                text: "Ir a Perfil",
                                onClick: function(nodeId) {
                                    // Obtener los datos del nodo para construir la URL
                                    const nodeData = chart.get(nodeId);
                                    if (nodeData) {
                                        // Ejemplo: Redirigir a una p√°gina de perfil usando el ID del nodo
                                        // Aseg√∫rate de que tu p√°gina de destino pueda manejar el par√°metro 'id'
                                        alert('Hola ',nodeData.nombre)
                                        window.location.href = `profile.html?id=${nodeData.id}`;
                                        // O si tienes una URL espec√≠fica en los datos del nodo:
                                        // if (nodeData.profileUrl) {
                                        //     window.location.href = nodeData.profileUrl;
                                        // } else {
                                        //     alert('URL de perfil no definida para este usuario.');
                                        // }
                                    }
                                }
                            },
                            // Puedes a√±adir m√°s botones aqu√≠
                            // myOtherButton: {
                            //     text: "Otra Acci√≥n",
                            //     onClick: function(nodeId) {
                            //         alert(`Realizando otra acci√≥n para el nodo: ${nodeId}`);
                            //     }
                            // }

                            edit: {
                                icon: OrgChart.icon.edit(24,24,'#fff'),
                                text: 'Edit',
                                hideIfEditMode: true,
                                hideIfDetailsMode: false
                            },
                            share: {
                                icon: OrgChart.icon.share(24,24,'#fff'),
                                text: 'Share',
                                hideIfDetailsMode: true

                            },
                            pdf: {
                                icon: OrgChart.icon.pdf(24,24,'#fff'),
                                text: 'Save as PDF',
                                hideIfDetailsMode: true
                            },
                            remove: {
                                icon: OrgChart.icon.remove(24,24,'#fff'),
                                text: 'Remove',
                                hideIfDetailsMode: true
                            }
                        },
                        /* elements: [
                            { type: 'textbox', label: 'Full Name', binding: 'Name' },
                            { type: 'textbox', label: 'Phone number', binding: 'phone' }        
                        ] */

                        /* ... (tu configuraci√≥n del editForm) ... */ 
                    },
                    menu: {
                        pdf_export: {
                            text: "Export PDF",
                            //icon: pdfIcon
                        },
                        png_export: {
                            text: "Export PNG",
                            //icon: pngIcon
                        },
                        svg_export: {
                            text: "Export SVG",
                            //icon: svgIcon
                        },
                        csv_export: {
                            text: "Export CSV",
                            //icon: csvIcon
                        }
                    },
                    
                    //nodeClick: OrgChart.action,
                    nodeSeparation: 65,
                    //levelSeparation: 120,    // Espacio entre niveles
                    siblingSeparation: 100, // Espacio entre nodos hermanos
                    partnerNodeSeparation: 15,
                };
                
                //PERSONALIZAR IA
                // Aqu√≠ se le pueden dar instrucciones al sistema de IA para que entienda el contexto de la empresa
                OrgChart.AI_SYSTEM_MESSAGES = ["Trabajas para una empresa llamada LIRIS que se dedica desde el balanceado, criadero de pollos hasta su venta y distribuci√≥n a dem√°s de contar con supermercados retail llamado DelPortal en Guayaquil, Ecuador. El organigrama se trata del equipo de trabajo de esta empresa. La oficina de LIRIS queda en Samborondon, Ecuador."];
                OrgChart.SEARCH_PLACEHOLDER = "Buscar por nombre o puesto...";
                OrgChart.aiUI.title = "AI for LIRIS S.A."; //
                
                /////////////////////////
                chart = new OrgChart(treeDiv, chartConfig);
                
                const searchInput = chart
                console.log("Search Input Element:", searchInput);

                chart.searchUI.on('searchclick', function (sender, args) {
                    sender.instance.center(args.nodeId, null, function(){
                        sender.instance.zoom(1.5);
                    });
                    return false; 
                });  


                chart.onInit(function(){
                    //this.aiUI.show(true)
                    //this.aiUI.inputElement.value = '¬øQu√© puedes hacer?'
                    console.log("Funcionando...", this);
                    // chart.config.scaleInitial = OrgChart.match.boundary;
                    // chart._draw(true, OrgChart.action.init, { method: 'fit' });
                    procesarLoginDeUsuario();
                })

                function iterate(c, n, collapseIds, id) {
                    if (id != n.id) {
                        collapseIds.push(n.id);
                    }

                    for (var i = 0; i < n.childrenIds.length; i++) {
                        iterate(c, c.getNode(n.childrenIds[i]), collapseIds, id)
                    }
                }


                // Barra de zoom
                /* chart.onInit(function(){
                    rangeScaleElement.min = this.config.scaleMin * sensitivity;
                    rangeScaleElement.max = this.config.scaleMax * sensitivity;    
                    rangeScaleElement.value = this.getScale() * sensitivity;
                });

                rangeScaleElement.addEventListener('input', function(){
                    chart.setScale(this.value / sensitivity);
                    txtScaleElement.innerHTML = rangeScaleElement.value / sensitivity;
                }); */


                //////// NODO con height Din√°mico
                /* 
                chart.on('field', function (sender, args) {
                    console.log("Field event:", args);
                    if (args.name == 'img') {
                        let text1 = args.data["nombre"];
                        let text2 = args.data["puesto"];
                        let img = args.data["img"];

                        args.value = `<foreignobject x="10" y="10" width="200" height="200">
                                            <div class="fields" xmlns="http://www.w3.org/1999/xhtml" >
                                                ${text1 ? '<p>' + text1 + '</p>' : ''}
                                                ${text2 ? '<p>' + text2 + '</p>' : ''}
                                                ${img ? '<img src="' + img + '" alt="Imagen" />' : ''}
                                            </div>
                                        </foreignobject>`;
                    }
                });

                


                chart.on('node-initialized', function (sender, args) {
                    let node = args.node;
                    let data = chart._get(node.id);
                    console.log(data)
                    if (data.nombre) {
                        let text1 = data["nombre"];
                        let text2 = data["puesto"];
                        let img = data["img"];

                        let sss = `<foreignobject  x="10" y="10" width="200" height="20">
                                            <div class="fields">
                                                ${text1 ? '<p>' + text1 + '</p>' : ''}
                                                ${text2 ? '<p>' + text2 + '</p>' : ''}
                                                ${img ? '<img src="' + img + '" alt="Imagen" />' : ''}
                                            </div>
                                        </foreignobject>`;

                        document.getElementById('test_height').innerHTML = sss;

                        let rect1 = document.querySelector('#test_height .fields').getBoundingClientRect();

                        node.h = rect1.height + 45;
                    }
                }); */

                statusDiv.style.display = "none"; // Ocultar "Cargando..."

            } catch (error) {
                console.error("ERROR DETALLADO:", error);
                statusDiv.innerText = "Error.";
                errorDiv.innerText = `Error: ${error.message}. Revisa la consola (F12).`;
                errorDiv.style.display = "block";
            }
        }

        // --- Llamada inicial ---
        document.addEventListener('DOMContentLoaded', function () {
            const apiUrl = 'https://mobileqa.liris.com.ec/delportal/wp-json/delportal/v1/get_organigrama_persona';
            loadAndRenderChart(apiUrl);
        });
    </script>

</body>
</html>